<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Grocery ERP</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Use Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }

        /* Enhanced Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.3);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(249, 115, 22, 0.4);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(100, 116, 139, 0.3);
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(100, 116, 139, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(239, 68, 68, 0.4);
        }

        /* Enhanced Card Styles */
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Enhanced Input Styles */
        .input-enhanced {
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
        }
        .input-enhanced:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        /* Loading Animation */
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }

        /* Enhanced Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
        }

        /* Status Indicators */
        .status-online {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .status-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .status-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        /* Chat bubble styles */
        .bubble {
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            max-width: 90%;
            word-wrap: break-word;
        }
        .user-bubble {
             /* Orange theme */
            background-color: #f97316; /* orange-600 */
            color: white;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
        .ai-bubble {
             /* Orange theme */
            background-color: #ffedd5; /* orange-100 */
            color: #1e293b; /* gray-800 */
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }

        /* Pulsing animation for mic button */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }
        .listening {
            animation: pulse 1.5s infinite;
        }
        
        /* Enhanced Dashboard Animations */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .dashboard-card-icon {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover .dashboard-card-icon {
            transform: scale(1.1) rotate(5deg);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        /* Professional Color Scheme */
        .primary-gradient {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        
        .secondary-gradient {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .success-gradient {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .warning-gradient {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .danger-gradient {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        /* Enhanced Animations */
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .hover-scale:hover {
            transform: scale(1.05);
        }
        
        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.3);
        }
        
        /* Professional Button Styles */
        .btn-professional {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-professional::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-professional:hover::before {
            left: 100%;
        }
        
        .btn-professional:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(249, 115, 22, 0.4);
        }
        
        /* Enhanced Card Styles */
        .card-professional {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .card-professional:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Mobile Optimizations */
        @media (max-width: 640px) {
            .mobile-padding {
                padding: 1rem;
            }
            
            .mobile-text {
                font-size: 0.875rem;
            }
            
            .mobile-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }
        }
        
        /* Tablet Optimizations */
        @media (min-width: 641px) and (max-width: 1024px) {
            .tablet-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1; /* gray-300 */
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
             /* Orange theme */
            background-color: #f97316; /* orange-600 */
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Hide scrollbar for main content, but allow scrolling */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Style for clickable product cards */
        #product-list .product-card {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        #product-list .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
        }

        /* Custom Confirmation Modal */
        .confirm-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(17, 24, 39, 0.5); /* gray-900 with opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        /* --- NEW STYLES FOR DARK SIDEBAR --- */
        .dark-sidebar {
            background-color: #0f172a; /* slate-900 */
            border-right: 1px solid #1e293b; /* slate-800 */
        }
        .dark-sidebar .nav-link {
            color: #cbd5e1; /* slate-300 */
            transition: all 0.2s ease;
        }
        .dark-sidebar .nav-link:hover {
            background-color: #334155; /* slate-700 */
            color: #ffffff; /* white */
        }
        .dark-sidebar .nav-link.active {
            background-color: #f97316; /* orange-600 */
            color: #ffffff; /* white */
            font-weight: 600; /* semibold */
        }
        .dark-sidebar .nav-link.active i {
             color: #ffffff !important;
        }
        /* --- END NEW STYLES --- */

        /* --- NEW STYLES FOR GRADIENT BUTTONS --- */
        .btn-primary {
            @apply bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold shadow-md hover:shadow-lg hover:shadow-orange-300/50 transition-all duration-300 transform hover:-translate-y-0.5 rounded-lg;
        }
        .btn-danger {
            @apply bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold shadow-md hover:shadow-lg hover:shadow-red-300/50 transition-all duration-300 transform hover:-translate-y-0.5 rounded-lg;
        }
        .btn-secondary {
             @apply bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors;
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-900 min-h-screen">

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center h-screen bg-gradient-to-br from-slate-50 to-slate-200">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-2xl mx-4">
            <div class="flex justify-center">
                 <!-- Orange theme -->
                <div class="p-4 bg-orange-100 rounded-full">
                    <i data-lucide="shopping-cart" class="w-16 h-16 text-orange-600"></i>
                </div>
            </div>
            <h2 class="text-3xl font-bold text-center text-gray-800" data-lang-key="erp_title">David Grocerry</h2>
            <div class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-600">Email</label>
                     <!-- Orange theme -->
                    <input type="email" id="username" value="test@gmail.com" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-lg py-2.5 px-4 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-600">Password</label>
                     <!-- Orange theme -->
                    <input type="password" id="password" value="123456" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-lg py-2.5 px-4 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                 <!-- Orange theme -->
                <button id="login-btn" class="w-full btn-primary py-3 px-4">
                    Login
                </button>
                <p id="login-error" class="text-sm text-red-600 text-center hidden">Invalid username or password.</p>
                <div class="text-center">
                    <span class="text-gray-600">Don't have an account? </span>
                    <button id="show-signup-btn" class="text-orange-700 hover:text-orange-800 font-medium">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Signup Screen -->
    <div id="signup-screen" class="flex items-center justify-center h-screen bg-gradient-to-br from-slate-50 to-slate-200 hidden">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-2xl mx-4">
            <div class="flex justify-center">
                 <!-- Orange theme -->
                <div class="p-4 bg-orange-100 rounded-full">
                    <i data-lucide="user-plus" class="w-16 h-16 text-orange-600"></i>
                </div>
            </div>
            <h2 class="text-3xl font-bold text-center text-gray-800">Create Account</h2>
            
            <!-- Registration Form -->
            <div id="signup-form" class="space-y-4">
                <div>
                    <label for="signup-name" class="block text-sm font-medium text-gray-600">Full Name</label>
                    <input type="text" id="signup-name" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-lg py-2.5 px-4 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Enter your full name">
                </div>
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-gray-600">Email</label>
                    <input type="email" id="signup-email" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-lg py-2.5 px-4 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Enter your email">
                    <p class="text-xs text-gray-500 mt-1">Only Gmail and Email.com addresses are allowed</p>
                </div>
                <div>
                    <label for="signup-mobile" class="block text-sm font-medium text-gray-600">Mobile Number</label>
                    <input type="tel" id="signup-mobile" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-lg py-2.5 px-4 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Enter 10-digit mobile number" maxlength="10">
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-600">Password</label>
                    <input type="password" id="signup-password" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-lg py-2.5 px-4 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Enter your password">
                </div>
                <div>
                    <label for="signup-confirm-password" class="block text-sm font-medium text-gray-600">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-lg py-2.5 px-4 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Confirm your password">
                </div>
                 <!-- Orange theme -->
                <button id="signup-btn" class="w-full btn-primary py-3 px-4">
                    Create Account
                </button>
                <p id="signup-error" class="text-sm text-red-600 text-center hidden"></p>
                <div class="text-center">
                    <span class="text-gray-600">Already have an account? </span>
                    <button id="show-login-btn" class="text-orange-600 hover:text-orange-700 font-medium">Sign In</button>
                </div>
            </div>

            <!-- OTP Verification Form -->
            <div id="otp-form" class="space-y-4 hidden">
                <div class="text-center">
                    <div class="p-4 bg-green-100 rounded-full w-16 h-16 mx-auto mb-4">
                        <i data-lucide="mail" class="w-8 h-8 text-green-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Verify Your Email</h3>
                    <p class="text-gray-600 mt-2">We've sent a verification code to <span id="otp-email" class="font-medium"></span></p>
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 mt-3">
                        <p class="text-sm text-orange-800 font-medium">🧪 Testing Mode</p>
                        <p class="text-xs text-orange-700">OTP is hardcoded as "1234" for testing purposes</p>
                    </div>
                </div>
                <div>
                    <label for="otp-input" class="block text-sm font-medium text-gray-600">Enter Verification Code</label>
                    <input type="text" id="otp-input" value="1234" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-lg py-2.5 px-4 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500 text-center text-lg tracking-widest" placeholder="1234" maxlength="4">
                    <p class="text-xs text-gray-500 mt-1">Enter the 4-digit code sent to your email</p>
                    <p class="text-xs text-orange-600 mt-1 font-medium">💡 For testing: OTP is always "1234"</p>
                </div>
                 <!-- Orange theme -->
                <button id="verify-otp-btn" class="w-full btn-primary py-3 px-4">
                    Verify & Complete Registration
                </button>
                <button id="resend-otp-btn" class="w-full btn-secondary py-2 px-4">
                    Resend Code (Always 1234)
                </button>
                <p id="otp-error" class="text-sm text-red-600 text-center hidden"></p>
                <div class="text-center">
                    <button id="back-to-signup-btn" class="text-orange-600 hover:text-orange-700 font-medium">← Back to Signup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main ERP Application (Hidden by default) -->
    <div id="erp-app" class="hidden flex h-screen">
        
        <!-- Sidebar Navigation (Desktop) -->
        <nav class="w-64 dark-sidebar flex-col flex-shrink-0 hidden lg:flex">
            <div class="flex items-center p-4 h-16 border-b border-slate-800">
                 <!-- Orange theme -->
                <div class="p-2 bg-orange-600 rounded-lg">
                    <i data-lucide="shopping-cart" class="w-8 h-8 text-white"></i>
                </div>
                <h1 class="text-xl font-bold text-white ml-3" data-lang-key="erp_title_short">Grocer ERP</h1>
            </div>
            <ul class="flex-1 flex flex-col py-4 space-y-1">
                <li>
                     <!-- Orange theme -->
                    <a href="#" id="nav-dashboard" class="nav-link flex items-center p-3 pl-4 rounded-xl mx-2">
                        <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                        <span class="ml-3" data-lang-key="nav_dashboard">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="nav-customers" class="nav-link flex items-center p-3 pl-4 rounded-xl mx-2">
                        <i data-lucide="users" class="w-6 h-6"></i>
                        <span class="ml-3" data-lang-key="nav_customers">Customers</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="nav-billing" class="nav-link flex items-center p-3 pl-4 rounded-xl mx-2">
                        <i data-lucide="receipt" class="w-6 h-6"></i>
                        <span class="ml-3" data-lang-key="nav_billing">Billing</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="nav-products" class="nav-link flex items-center p-3 pl-4 rounded-xl mx-2">
                        <i data-lucide="package" class="w-6 h-6"></i>
                        <span class="ml-3" data-lang-key="nav_products">Products</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="nav-purchase" class="nav-link flex items-center p-3 pl-4 rounded-xl mx-2">
                        <i data-lucide="truck" class="w-6 h-6"></i>
                        <span class="ml-3" data-lang-key="nav_purchase">Purchase</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="nav-assistant" class="nav-link flex items-center p-3 pl-4 rounded-xl mx-2">
                        <i data-lucide="brain-circuit" class="w-6 h-6"></i>
                        <span class="ml-3" data-lang-key="nav_assistant">Assistant</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="nav-reports" class="nav-link flex items-center p-3 pl-4 rounded-xl mx-2">
                        <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                        <span class="ml-3" data-lang-key="nav_reports">Reports</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="nav-upgrade" class="nav-link flex items-center p-3 pl-4 rounded-xl mx-2">
                        <i data-lucide="crown" class="w-6 h-6"></i>
                        <span class="ml-3" data-lang-key="nav_upgrade">Upgrade Plan</span>
                    </a>
                </li>
                <!-- REMOVED Add Entry Link -->
                <!-- Spacer -->
                <li class="flex-1"></li>
                <!-- Settings Link -->
                <li>
                    <a href="#" id="nav-settings" class="nav-link flex items-center p-3 pl-4 rounded-xl mx-2">
                        <i data-lucide="settings" class="w-6 h-6"></i>
                        <span class="ml-3" data-lang-key="nav_settings">Settings</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden">
            <!-- Top Header -->
            <header class="bg-white shadow-md p-3 sm:p-4 h-16 border-b border-slate-200 flex justify-between items-center flex-shrink-0 z-10">
                <div class="flex items-center space-x-4">
                    <h1 id="header-title" class="text-xl sm:text-2xl lg:text-3xl font-bold text-slate-800" data-lang-key="dashboard_title_dashboard">Dashboard</h1>
                    <!-- Current Time Display -->
                    <div id="current-time-display" class="hidden sm:flex items-center space-x-3 text-sm bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white px-4 py-2 rounded-xl shadow-lg border border-purple-500/20 backdrop-blur-sm">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse shadow-lg shadow-emerald-400/50"></div>
                            <i data-lucide="clock" class="w-4 h-4 text-white/90"></i>
                        </div>
                        <div class="font-mono text-lg text-white font-semibold tracking-wide">
                            <span id="current-time"></span>
                        </div>
                        <div class="w-1 h-6 bg-white/20 rounded-full"></div>
                        <div class="text-xs text-white/80 font-medium">
                            LIVE
                        </div>
                    </div>
                </div>
                <div class="flex items-center">
                    <!-- Subscription Status -->
                    <div id="subscription-status" class="hidden sm:flex items-center space-x-2 mr-4 px-3 py-1 bg-orange-100 rounded-full">
                        <i data-lucide="crown" class="w-4 h-4 text-orange-600"></i>
                        <span id="subscription-days" class="text-sm font-medium text-orange-700">30 days left</span>
                    </div>
                    
                    <!-- Mobile Language Toggle -->
                    <div class="flex items-center space-x-2 lg:hidden">
                        <span id="lang-en-label-mobile" class="text-gray-900 font-medium text-sm">EN</span>
                        <label class="switch">
                            <input type="checkbox" id="lang-toggle-mobile">
                            <span class="slider"></span>
                        </label>
                        <span id="lang-hi-label-mobile" class="text-gray-400 font-medium text-sm">HI</span>
                    </div>
                    <!-- User Profile Dropdown -->
                    <div class="ml-2 sm:ml-4 relative">
                        <button class="flex items-center space-x-2">
                             <!-- Orange theme -->
                            <img src="https://placehold.co/40x40/ffedd5/f97316?text=XYZ" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full ring-2 ring-offset-2 ring-orange-500" alt="User Avatar">
                            <div class="hidden sm:block text-left">
                                <span id="display-username" class="font-semibold text-gray-700 text-sm sm:text-base">xyz</span>
                                <span class="block text-xs text-gray-500">Admin</span>
                            </div>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Scrollable Content -->
            <main class="flex-1 overflow-y-auto no-scrollbar p-3 sm:p-4 lg:p-6 xl:p-8 bg-slate-100">

                <!-- View: Dashboard -->
                <div id="view-dashboard" class="data-view">
                    <!-- Dashboard Cards -->
                    <!-- UPDATED: 5 cards now -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 sm:gap-6">
                        <div class="card-professional p-4 sm:p-6 flex flex-col items-center text-center space-y-3 smooth-transition hover-lift">
                             <!-- Orange theme -->
                            <div class="p-3 rounded-xl bg-orange-100 dashboard-card-icon smooth-transition hover-scale">
                                <i data-lucide="users" class="w-8 h-8 text-orange-600"></i>
                            </div>
                            <div class="w-full">
                                <p class="text-xs sm:text-sm font-medium text-gray-500 mb-1" data-lang-key="card_total_customers">Total Customers</p>
                                <p id="dashboard-total-customers" class="text-2xl sm:text-3xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                        <div class="card-professional p-4 sm:p-6 flex flex-col items-center text-center space-y-3 smooth-transition hover-lift">
                            <div class="p-3 rounded-xl bg-blue-100 dashboard-card-icon smooth-transition hover-scale">
                                <i data-lucide="package" class="w-8 h-8 text-blue-600"></i>
                            </div>
                            <div class="w-full">
                                <p class="text-xs sm:text-sm font-medium text-gray-500 mb-1" data-lang-key="card_total_products">Total Products</p>
                                <p id="dashboard-total-products" class="text-2xl sm:text-3xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                        <div class="card-professional p-4 sm:p-6 flex flex-col items-center text-center space-y-3 smooth-transition hover-lift">
                            <div class="p-3 rounded-xl bg-red-100 dashboard-card-icon smooth-transition hover-scale">
                                <i data-lucide="indian-rupee" class="w-8 h-8 text-red-600"></i>
                            </div>
                            <div class="w-full">
                                <p class="text-xs sm:text-sm font-medium text-gray-500 mb-1" data-lang-key="card_balance_due">Total Balance Due</p>
                                <p id="dashboard-total-balance" class="text-2xl sm:text-3xl font-bold text-gray-900">₹0.0</p>
                            </div>
                        </div>
                         <!-- NEW: Daily Profit Card -->
                        <div class="card-professional p-4 sm:p-6 flex flex-col items-center text-center space-y-3 smooth-transition hover-lift">
                            <div class="p-3 rounded-xl bg-yellow-100 dashboard-card-icon smooth-transition hover-scale">
                                <i data-lucide="calendar-check" class="w-8 h-8 text-yellow-600"></i>
                            </div>
                            <div class="w-full">
                                <p class="text-xs sm:text-sm font-medium text-gray-500 mb-1" data-lang-key="card_daily_profit">Daily Profit</p>
                                <p id="dashboard-daily-profit" class="text-2xl sm:text-3xl font-bold text-gray-900">₹0.0</p>
                            </div>
                        </div>
                        <div class="card-professional p-4 sm:p-6 flex flex-col items-center text-center space-y-3 smooth-transition hover-lift">
                            <div class="p-3 rounded-xl bg-green-100 dashboard-card-icon smooth-transition hover-scale">
                                <i data-lucide="trending-up" class="w-8 h-8 text-green-600"></i>
                            </div>
                            <div class="w-full">
                                <p class="text-xs sm:text-sm font-medium text-gray-500 mb-1" data-lang-key="card_monthly_profit">Monthly Profit</p>
                                <p id="dashboard-monthly-profit" class="text-2xl sm:text-3xl font-bold text-gray-900">₹0.0</p>
                            </div>
                        </div>
                    </div>
                    <!-- End Dashboard Cards -->

                    <!-- Charts / Recent Activity -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4" data-lang-key="chart_title">Profit / Loss (Monthly)</h2>
                            <div class="h-64 bg-slate-100 rounded-lg flex items-center justify-center">
                                <p class="text-gray-500" data-lang-key="placeholder_chart">Chart placeholder - Full sales tracking needed.</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4 text-red-600 flex items-center">
                                <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                                <span data-lang-key="expiry_title">Expiry Alerts</span>
                            </h2>
                            <div id="expiry-alert-list" class="space-y-3 h-64 overflow-y-auto">
                                <p id="expiry-alert-placeholder" class="text-gray-500 text-center pt-10" data-lang-key="no_expiry">No products expiring soon.</p>
                                <!-- Alerts will be populated by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Low Stock Alerts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4 text-orange-600 flex items-center">
                                <i data-lucide="package-x" class="w-6 h-6 mr-2"></i>
                                <span data-lang-key="low_stock_title">Low Stock Alerts</span>
                            </h2>
                            <div id="low-stock-alert-list" class="space-y-3 h-64 overflow-y-auto">
                                <p id="low-stock-alert-placeholder" class="text-gray-500 text-center pt-10" data-lang-key="no_low_stock">No products with low stock.</p>
                                <!-- Low stock alerts will be populated by JS -->
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4 text-blue-600 flex items-center">
                                <i data-lucide="bar-chart-3" class="w-6 h-6 mr-2"></i>
                                <span data-lang-key="quick_stats_title">Quick Stats</span>
                            </h2>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span class="text-sm font-medium text-gray-600" data-lang-key="out_of_stock">Out of Stock</span>
                                    <span id="out-of-stock-count" class="text-lg font-bold text-red-600">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span class="text-sm font-medium text-gray-600" data-lang-key="low_stock_items">Low Stock Items</span>
                                    <span id="low-stock-count" class="text-lg font-bold text-orange-600">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span class="text-sm font-medium text-gray-600" data-lang-key="expiring_soon">Expiring Soon</span>
                                    <span id="expiring-soon-count" class="text-lg font-bold text-yellow-600">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-6 mt-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold mb-4" data-lang-key="recent_activity_title">Recent Activity</h2>
                            <div id="recent-activity-list" class="space-y-3 h-64 overflow-y-auto">
                                <p id="recent-activity-placeholder" class="text-gray-500 text-center pt-10" data-lang-key="no_activity">No recent activity.</p>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- View: Customers -->
                <div id="view-customers" class="data-view hidden">
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                        <header class="p-4 border-b border-slate-200 sticky top-0 z-10 flex flex-col md:flex-row md:items-center md:justify-between">
                            <!-- Search Bar -->
                            <div class="mt-1 flex-1">
                                <!-- Orange theme -->
                                <input type="search" id="customer-search" data-lang-key-placeholder="placeholder_search_customer" placeholder="Search customers..." class="w-full bg-slate-50 border border-slate-300 rounded-full py-2.5 px-5 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500">
                            </div>
                            <!-- Action Buttons -->
                            <div class="mt-2 md:mt-0 md:ml-4 flex space-x-2">
                                <!-- Add Customer Button -->
                                <button id="add-customer-btn" class="btn-primary py-2.5 px-4 flex-shrink-0 flex items-center justify-center">
                                    <i data-lucide="user-plus" class="w-5 h-5 mr-1.5"></i>
                                    <span data-lang-key="add_customer">Add Customer</span>
                                </button>
                                <!-- Download PDF Button -->
                                <button id="download-customers-pdf" class="btn-secondary py-2.5 px-4 flex-shrink-0 flex items-center justify-center">
                                    <i data-lucide="download" class="w-5 h-5 mr-1.5"></i>
                                    <span data-lang-key="download_pdf">Download PDF</span>
                                </button>
                            </div>
                        </header>
                        <div id="customer-pagination" class="p-4 border-b border-slate-200 flex justify-center items-center space-x-4">
                            <button id="customer-prev-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                            <span id="customer-page-info" class="text-sm font-medium text-gray-600">Page 1 of 1</span>
                            <button id="customer-next-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div id="customer-list" class="p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <p id="customer-list-placeholder" class="text-gray-500 text-center col-span-full py-10" data-lang-key="no_customers">No customers found. Add one!</p>
                        </div>
                    </div>
                </div>

                <!-- View: Billing -->
                <div id="view-billing" class="data-view hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- New Bill Form -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h2 class="text-xl font-semibold text-gray-800" data-lang-key="billing_title">New Bill</h2>
                        <div class="space-y-4 mt-4">
                            <div>
                                <label for="billing-customer-search" class="block text-sm font-medium text-gray-600" data-lang-key="form_customer">Customer</label>
                                 <!-- Orange theme -->
                                <input type="text" id="billing-customer-search" list="customer-datalist" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Type or select a customer...">
                                <datalist id="customer-datalist">
                                    <!-- Options will be populated by JS -->
                                </datalist>
                            </div>
                            <div class="border-t border-slate-200 pt-4">
                                <h3 class="text-lg font-medium text-gray-700" data-lang-key="billing_add_item">Add Item</h3>
                                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-2">
                                    <div class="md:col-span-3">
                                        <label for="billing-product" class="block text-sm font-medium text-gray-600" data-lang-key="form_product_name">Product</label>
                                        <div class="flex space-x-2">
                                        <!-- Orange theme -->
                                            <select id="billing-product" class="mt-1 block flex-1 bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                            <option value="" data-lang-key="select_product">Select a product...</option>
                                            <!-- Options will be populated by JS -->
                                        </select>
                                            <!-- Scanner Button -->
                                            <button id="scanner-btn" class="mt-1 bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-1" title="Scan Product Barcode">
                                                <i data-lucide="scan-line" class="w-4 h-4"></i>
                                                <span class="hidden sm:inline">Scan</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="billing-qty" class="block text-sm font-medium text-gray-600" data-lang-key="form_quantity">Quantity</label>
                                         <!-- Orange theme -->
                                        <input type="number" id="billing-qty" value="1" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    </div>
                                    <div>
                                        <label for="billing-unit" class="block text-sm font-medium text-gray-600" data-lang-key="form_unit">Unit</label>
                                         <!-- Orange theme -->
                                        <select id="billing-unit" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                            <!-- Options will be populated by JS based on product -->
                                        </select>
                                    </div>
                                </div>
                                <button id="add-to-bill-btn" class="mt-4 w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2" data-lang-key="form_add_item">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    <span>Add Item</span>
                                </button>
                                
                                <!-- Quick Add Buttons -->
                                <div class="mt-4 grid grid-cols-2 gap-2">
                                    <button id="quick-add-1" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 rounded-lg text-sm transition-colors">
                                        +1 Qty
                                    </button>
                                    <button id="quick-add-5" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-3 rounded-lg text-sm transition-colors">
                                        +5 Qty
                                </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Bill Summary -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h2 class="text-xl font-semibold text-gray-800" data-lang-key="billing_summary">Bill Summary</h2>
                        <p class="text-lg font-medium text-gray-700 mt-4">
                            Customer: 
                             <!-- Orange theme -->
                            <span id="billing-customer-name" class="text-orange-600 font-semibold">None</span>
                        </p>
                        <div id="billing-items-list" class="mt-4 space-y-2 border-t border-slate-200 pt-2 min-h-[100px]">
                            <p id="billing-items-placeholder" class="text-sm text-gray-500 text-center" data-lang-key="no_items">No items added to bill.</p>
                        </div>
                        <div class="border-t border-gray-300 mt-4 pt-4">
                            <p class="text-xl font-bold text-gray-900 flex justify-between">
                                <span data-lang-key="billing_total">Total:</span>
                                <span id="billing-total">₹0.00</span>
                            </p>
                            
                            <!-- Payment Method Selection -->
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-600 mb-2" data-lang-key="payment_method">Payment Method</label>
                                <div class="flex space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="payment-method" value="cash" class="mr-2 text-orange-600 focus:ring-orange-500" checked>
                                        <span class="text-sm font-medium text-gray-700" data-lang-key="payment_cash">Cash</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="payment-method" value="due" class="mr-2 text-orange-600 focus:ring-orange-500">
                                        <span class="text-sm font-medium text-gray-700" data-lang-key="payment_due">Due</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Orange theme -->
                            <button id="finalize-bill-btn" class="mt-4 w-full btn-primary py-3 px-4" data-lang-key="billing_finalize">
                                Finalize Bill
                            </button>
                            <p id="billing-status" class="text-sm text-green-600 text-center mt-2"></p>
                        </div>
                    </div>
                </div>

                <!-- View: Products -->
                <div id="view-products" class="data-view hidden">
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                         <header class="p-4 border-b border-slate-200 sticky top-0 z-10 flex flex-col md:flex-row md:items-center md:justify-between">
                            <!-- Search Bar -->
                            <div class="mt-1 flex-1">
                                <!-- Orange theme -->
                                <input type="search" id="product-search" data-lang-key-placeholder="placeholder_search_product" placeholder="Search products..." class="w-full bg-slate-50 border border-slate-300 rounded-full py-2.5 px-5 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500">
                            </div>
                            <!-- Action Buttons -->
                            <div class="mt-2 md:mt-0 md:ml-4 flex space-x-2">
                                <!-- Scanner Button -->
                                <button id="product-scanner-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-2.5 px-4 flex-shrink-0 flex items-center justify-center rounded-lg transition-colors">
                                    <i data-lucide="scan-line" class="w-5 h-5 mr-1.5"></i>
                                    <span>Scan</span>
                                </button>
                                <!-- Add Product Button -->
                                <button id="add-product-btn" class="btn-primary py-2.5 px-4 flex-shrink-0 flex items-center justify-center">
                                    <i data-lucide="plus" class="w-5 h-5 mr-1.5"></i>
                                    <span data-lang-key="add_product">Add Product</span>
                                </button>
                                <!-- Download PDF Button -->
                                <button id="download-products-pdf" class="btn-secondary py-2.5 px-4 flex-shrink-0 flex items-center justify-center">
                                    <i data-lucide="download" class="w-5 h-5 mr-1.5"></i>
                                    <span data-lang-key="download_pdf">Download PDF</span>
                                </button>
                            </div>
                        </header>
                        <div id="product-pagination" class="p-4 border-b border-slate-200 flex justify-center items-center space-x-4">
                            <button id="product-prev-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                            <span id="product-page-info" class="text-sm font-medium text-gray-600">Page 1 of 1</span>
                            <button id="product-next-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div id="product-list" class="p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                             <p id="product-list-placeholder" class="text-gray-500 text-center col-span-full py-10" data-lang-key="no_products">No products found. Add one!</p>
                        </div>
                    </div>
                </div>
                
                <!-- View: Purchase -->
                <div id="view-purchase" class="data-view hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- New PO Form -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h2 class="text-xl font-semibold text-gray-800" data-lang-key="po_title">New Purchase Order</h2>
                        <div class="space-y-4 mt-4">
                            <div>
                                <label for="po-supplier" class="block text-sm font-medium text-gray-600" data-lang-key="form_supplier">Supplier Name</label>
                                <!-- Orange theme -->
                                <input type="text" id="po-supplier" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                            </div>
                            <div>
                                <label for="po-product" class="block text-sm font-medium text-gray-600" data-lang-key="form_product_name">Product</label>
                                <!-- Orange theme -->
                                <select id="po-product" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="" data-lang-key="select_product">Select a product...</option>
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="po-qty" class="block text-sm font-medium text-gray-600" data-lang-key="form_quantity">Quantity</label>
                                     <!-- Orange theme -->
                                    <input type="number" id="po-qty" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label for="po-cost" class="block text-sm font-medium text-gray-600" data-lang-key="form_cost_price">Unit Cost (₹)</label>
                                     <!-- Orange theme -->
                                    <input type="number" id="po-cost" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>
                            </div>
                            <button id="add-po-item-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2.5 px-4 rounded-lg transition-colors duration-200" data-lang-key="form_add_item">
                                Add Item
                            </button>
                            <div id="po-items-list" class="space-y-2 border-t border-slate-200 pt-2">
                                <!-- PO items will be listed here -->
                            </div>
                             <!-- Orange theme -->
                            <button id="save-po-btn" class="w-full btn-primary py-3 px-4" data-lang-key="form_save_po">
                                Save Purchase Order
                            </button>
                        </div>
                    </div>
                    <!-- PO List -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-800" data-lang-key="po_list_title">Past Purchase Orders</h2>
                        <div id="po-list" class="mt-4 space-y-3">
                             <p id="po-list-placeholder" class="text-gray-500 text-center py-10" data-lang-key="no_po">No purchase orders found.</p>
                        </div>
                    </div>
                </div>

                <!-- View: Assistant -->
                <div id="view-assistant" class="data-view hidden">
                    <div class="w-full max-w-6xl mx-auto">
                        <!-- AI Assistant Header -->
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 text-white">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                <div class="flex items-center space-x-3 sm:space-x-4 mb-4 sm:mb-0">
                                    <div class="p-2 sm:p-3 bg-white bg-opacity-20 rounded-xl">
                                        <i data-lucide="brain-circuit" class="w-6 h-6 sm:w-8 sm:h-8"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-xl sm:text-2xl font-bold" data-lang-key="assistant_title">AI Assistant</h2>
                                        <p class="text-orange-100 text-sm" data-lang-key="assistant_subtitle">Your intelligent business companion</p>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between sm:justify-end sm:space-x-4">
                                    <!-- Language Switch for Voice Assistant -->
                                    <div class="flex items-center space-x-2 bg-white bg-opacity-20 rounded-lg px-3 py-2">
                                        <span class="text-sm font-medium">EN</span>
                                        <label class="switch">
                                            <input type="checkbox" id="lang-toggle-assistant">
                                            <span class="slider"></span>
                                        </label>
                                        <span class="text-sm font-medium">HI</span>
                                </div>
                                <div class="text-right">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <div class="w-2 h-2 sm:w-3 sm:h-3 bg-green-400 rounded-full animate-pulse"></div>
                                            <span class="text-xs sm:text-sm font-medium" id="status" data-lang-key="status_ready">Ready</span>
                                    </div>
                                    <p class="text-xs text-orange-100" data-lang-key="assistant_status">Always available to help</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Capabilities Cards -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-4 sm:mb-6">
                            <div class="bg-white rounded-lg shadow-md p-3 sm:p-4 border border-slate-200">
                                <div class="flex items-center space-x-3">
                                    <div class="p-2 bg-blue-100 rounded-lg">
                                        <i data-lucide="package" class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-800 text-xs sm:text-sm" data-lang-key="capability_inventory">Inventory Management</h3>
                                        <p class="text-xs text-gray-500" data-lang-key="capability_inventory_desc">Track stock levels</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-md p-3 sm:p-4 border border-slate-200">
                                <div class="flex items-center space-x-3">
                                    <div class="p-2 bg-green-100 rounded-lg">
                                        <i data-lucide="receipt" class="w-4 h-4 sm:w-5 sm:h-5 text-green-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-800 text-xs sm:text-sm" data-lang-key="capability_billing">Smart Billing</h3>
                                        <p class="text-xs text-gray-500" data-lang-key="capability_billing_desc">Process transactions</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-md p-3 sm:p-4 border border-slate-200 sm:col-span-2 lg:col-span-1">
                                <div class="flex items-center space-x-3">
                                    <div class="p-2 bg-purple-100 rounded-lg">
                                        <i data-lucide="bar-chart-3" class="w-4 h-4 sm:w-5 sm:h-5 text-purple-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-800 text-xs sm:text-sm" data-lang-key="capability_analytics">Business Analytics</h3>
                                        <p class="text-xs text-gray-500" data-lang-key="capability_analytics_desc">Generate insights</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Interface -->
                        <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden" style="height: 60vh; min-height: 500px;">
                            <!-- Chat Header -->
                            <div class="bg-slate-50 border-b border-slate-200 p-3 sm:p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2 sm:space-x-3">
                                        <div class="w-6 h-6 sm:w-8 sm:h-8 bg-orange-100 rounded-full flex items-center justify-center">
                                            <i data-lucide="bot" class="w-3 h-3 sm:w-4 sm:h-4 text-orange-600"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-gray-800 text-sm sm:text-base" data-lang-key="ai_name">AI Assistant</h3>
                                            <p class="text-xs text-gray-500" data-lang-key="ai_status">Online</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-1 sm:space-x-2">
                                        <button id="clear-chat-btn" class="text-gray-400 hover:text-gray-600 p-1" data-lang-key="clear_chat" title="Clear Chat">
                                            <i data-lucide="trash-2" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                        </button>
                                        <button id="voice-toggle-btn" class="text-gray-400 hover:text-gray-600 p-1" data-lang-key="voice_toggle" title="Toggle Voice">
                                            <i data-lucide="mic" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Chat Messages -->
                            <main id="chat-log" class="flex-grow p-3 sm:p-4 space-y-3 sm:space-y-4 overflow-y-auto" style="height: calc(60vh - 160px); min-height: 320px;">
                                <!-- Enhanced Welcome Message -->
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="bot" class="w-4 h-4 text-orange-600"></i>
                                    </div>
                                    <div class="bg-orange-50 rounded-lg p-4 max-w-md">
                                        <p class="text-gray-800 font-medium mb-2" data-lang-key="welcome_title">Welcome to AI Assistant!</p>
                                        <p class="text-sm text-gray-600 mb-3" data-lang-key="welcome_desc">I can help you manage your grocery business efficiently. Here's what I can do:</p>
                                        <ul class="text-xs text-gray-600 space-y-1">
                                            <li>• <span data-lang-key="help_inventory">Track inventory and stock levels</span></li>
                                            <li>• <span data-lang-key="help_billing">Process customer bills and payments</span></li>
                                            <li>• <span data-lang-key="help_reports">Generate business reports</span></li>
                                            <li>• <span data-lang-key="help_customers">Manage customer information</span></li>
                                        </ul>
                                        <p class="text-xs text-gray-500 mt-2" data-lang-key="welcome_ask">Ask me anything about your business!</p>
                                    </div>
                                </div>
                            </main>

                            <!-- Loading Indicator -->
                            <div id="loading" class="hidden text-center p-4 border-t border-slate-200 bg-slate-50">
                                <div class="flex items-center justify-center space-x-2">
                                    <div class="flex space-x-1">
                                        <div class="w-2 h-2 bg-orange-500 rounded-full animate-bounce"></div>
                                        <div class="w-2 h-2 bg-orange-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                        <div class="w-2 h-2 bg-orange-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                    </div>
                                    <span class="text-sm text-gray-600" data-lang-key="status_processing">AI is thinking...</span>
                                </div>
                            </div>

                            <!-- Input Area -->
                            <footer class="bg-slate-50 p-3 sm:p-4 border-t border-slate-200">
                                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-3">
                                    <div class="flex-grow w-full sm:w-auto relative">
                                        <input type="text" id="text-input" data-lang-key-placeholder="placeholder_message" placeholder="Type your message or command..." class="w-full bg-white border border-slate-300 rounded-full py-3 px-5 pr-12 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <button id="mic-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-orange-600 transition-colors">
                                            <i data-lucide="mic" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                    <button id="send-btn" class="bg-orange-600 hover:bg-orange-700 rounded-full p-3 text-white transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500 shadow-lg w-full sm:w-auto">
                                        <i data-lucide="send" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div class="mt-2 flex items-center justify-between text-xs text-gray-500">
                                    <span data-lang-key="input_hint">Press Enter to send, or click the microphone for voice input</span>
                                    <span id="typing-indicator" class="hidden" data-lang-key="typing">Typing...</span>
                                </div>
                            </footer>
                        </div>
                    </div>
                </div>

                <!-- View: Reports -->
                <div id="view-reports" class="data-view hidden">
                    <div class="w-full max-w-6xl mx-auto space-y-6">
                        <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-6" data-lang-key="reports_title">Business Reports</h2>
                            
                            <!-- Report Filters -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2" data-lang-key="report_period">Period</label>
                                    <select id="report-period" class="w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="today" data-lang-key="period_today">Today</option>
                                        <option value="week" data-lang-key="period_week">This Week</option>
                                        <option value="month" data-lang-key="period_month">This Month</option>
                                        <option value="quarter" data-lang-key="period_quarter">This Quarter</option>
                                        <option value="year" data-lang-key="period_year">This Year</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2" data-lang-key="report_type">Report Type</label>
                                    <select id="report-type" class="w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="sales" data-lang-key="report_sales">Sales Report</option>
                                        <option value="profit" data-lang-key="report_profit">Profit Report</option>
                                        <option value="inventory" data-lang-key="report_inventory">Inventory Report</option>
                                        <option value="customers" data-lang-key="report_customers">Customer Report</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2" data-lang-key="report_format">Format</label>
                                    <select id="report-format" class="w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="pdf" data-lang-key="format_pdf">PDF</option>
                                        <option value="excel" data-lang-key="format_excel">Excel</option>
                                        <option value="csv" data-lang-key="format_csv">CSV</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="generate-report-btn" class="w-full btn-primary py-2 px-4" data-lang-key="generate_report">
                                        <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                                        Generate Report
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Report Preview -->
                            <div class="bg-slate-50 rounded-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4" data-lang-key="report_preview">Report Preview</h3>
                                
                                <!-- Charts Container -->
                                <div id="charts-container" class="space-y-6">
                                    <!-- Sales Chart -->
                                    <div id="sales-chart-container" class="hidden">
                                        <h4 class="text-md font-semibold text-gray-700 mb-3">Sales Trend</h4>
                                        <div class="bg-white rounded-lg p-4 shadow-sm">
                                            <canvas id="sales-chart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- Profit Chart -->
                                    <div id="profit-chart-container" class="hidden">
                                        <h4 class="text-md font-semibold text-gray-700 mb-3">Profit Analysis</h4>
                                        <div class="bg-white rounded-lg p-4 shadow-sm">
                                            <canvas id="profit-chart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- Inventory Chart -->
                                    <div id="inventory-chart-container" class="hidden">
                                        <h4 class="text-md font-semibold text-gray-700 mb-3">Inventory Status</h4>
                                        <div class="bg-white rounded-lg p-4 shadow-sm">
                                            <canvas id="inventory-chart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- Customer Chart -->
                                    <div id="customer-chart-container" class="hidden">
                                        <h4 class="text-md font-semibold text-gray-700 mb-3">Customer Analysis</h4>
                                        <div class="bg-white rounded-lg p-4 shadow-sm">
                                            <canvas id="customer-chart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- Default Message -->
                                <div id="report-preview" class="text-center text-gray-500 py-10">
                                        <i data-lucide="bar-chart-3" class="w-12 h-12 mx-auto mb-4 text-gray-400"></i>
                                    <p data-lang-key="select_report_options">Select report options above to generate preview</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View: Upgrade Plan -->
                <div id="view-upgrade" class="data-view hidden">
                    <div class="w-full max-w-4xl mx-auto space-y-6">
                        <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-6" data-lang-key="upgrade_title">Upgrade Your Plan</h2>
                            
                            <!-- Current Plan -->
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-orange-800" data-lang-key="current_plan">Current Plan</h3>
                                        <p class="text-orange-600" data-lang-key="plan_basic">Basic Plan - Free</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-orange-600" data-lang-key="plan_features">Limited Features</p>
                                        <p class="text-xs text-orange-500" data-lang-key="plan_storage">Local Storage Only</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Upgrade Options -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Pro Plan -->
                                <div class="border border-slate-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                                    <div class="text-center mb-4">
                                        <h3 class="text-xl font-semibold text-gray-800" data-lang-key="plan_pro">Pro Plan</h3>
                                        <p class="text-3xl font-bold text-orange-600 mt-2">₹999<span class="text-sm text-gray-500">/month</span></p>
                                    </div>
                                    <ul class="space-y-2 mb-6">
                                        <li class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2"></i>
                                            <span data-lang-key="feature_unlimited_products">Unlimited Products</span>
                                        </li>
                                        <li class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2"></i>
                                            <span data-lang-key="feature_unlimited_customers">Unlimited Customers</span>
                                        </li>
                                        <li class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2"></i>
                                            <span data-lang-key="feature_cloud_backup">Cloud Backup</span>
                                        </li>
                                        <li class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2"></i>
                                            <span data-lang-key="feature_advanced_reports">Advanced Reports</span>
                                        </li>
                                        <li class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2"></i>
                                            <span data-lang-key="feature_priority_support">Priority Support</span>
                                        </li>
                                    </ul>
                                    <button class="w-full btn-primary py-2 px-4" data-lang-key="upgrade_to_pro">
                                        Upgrade to Pro
                                    </button>
                                </div>
                                
                                <!-- Enterprise Plan -->
                                <div class="border border-orange-300 rounded-lg p-6 hover:shadow-lg transition-shadow bg-orange-50">
                                    <div class="text-center mb-4">
                                        <h3 class="text-xl font-semibold text-gray-800" data-lang-key="plan_enterprise">Enterprise Plan</h3>
                                        <p class="text-3xl font-bold text-orange-600 mt-2">₹2999<span class="text-sm text-gray-500">/month</span></p>
                                    </div>
                                    <ul class="space-y-2 mb-6">
                                        <li class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2"></i>
                                            <span data-lang-key="feature_all_pro">Everything in Pro</span>
                                        </li>
                                        <li class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2"></i>
                                            <span data-lang-key="feature_multi_location">Multi-Location Support</span>
                                        </li>
                                        <li class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2"></i>
                                            <span data-lang-key="feature_api_access">API Access</span>
                                        </li>
                                        <li class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2"></i>
                                            <span data-lang-key="feature_custom_integrations">Custom Integrations</span>
                                        </li>
                                        <li class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2"></i>
                                            <span data-lang-key="feature_dedicated_support">Dedicated Support</span>
                                        </li>
                                    </ul>
                                    <button class="w-full btn-primary py-2 px-4" data-lang-key="upgrade_to_enterprise">
                                        Upgrade to Enterprise
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Recharge Alert -->
                            <div id="recharge-alert" class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4 hidden">
                                <div class="flex items-center">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-600 mr-3"></i>
                                    <div>
                                        <h4 class="text-sm font-semibold text-yellow-800" data-lang-key="recharge_warning">Recharge Running Low</h4>
                                        <p class="text-sm text-yellow-600" data-lang-key="recharge_message">Your current plan recharge is running low. Consider upgrading to avoid service interruption.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View: Add Entry - REMOVED -->

                <!-- View: Settings -->
                <div id="view-settings" class="data-view hidden">
                    <div class="w-full max-w-4xl mx-auto space-y-6">
                        <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                            <h2 class="text-2xl font-semibold text-gray-800" data-lang-key="settings_title">Settings</h2>
                            
                            <!-- Language Toggle -->
                            <div class="mt-6">
                                <h3 class="text-lg font-medium text-gray-700" data-lang-key="settings_language">Language</h3>
                                <p class="text-sm text-gray-500 mb-3" data-lang-key="settings_language_desc">Choose your preferred language for the app.</p>
                                <div class="flex items-center justify-start space-x-2 bg-slate-50 p-4 rounded-lg">
                                    <span id="lang-en-label-settings" class="text-gray-900 font-medium text-sm">EN</span>
                                    <label class="switch">
                                        <input type="checkbox" id="lang-toggle-settings">
                                        <span class="slider"></span>
                                    </label>
                                    <span id="lang-hi-label-settings" class="text-gray-400 font-medium text-sm">HI</span>
                                </div>
                            </div>

                            <!-- Low Stock Threshold Setting -->
                            <div class="mt-6">
                                <h3 class="text-lg font-medium text-gray-700" data-lang-key="settings_low_stock_threshold">Low Stock Threshold</h3>
                                <p class="text-sm text-gray-500 mb-3" data-lang-key="settings_low_stock_desc">Set the minimum stock quantity to trigger low stock alerts.</p>
                                <div class="flex items-center space-x-3 bg-slate-50 p-4 rounded-lg">
                                    <label for="low-stock-threshold" class="text-sm font-medium text-gray-600" data-lang-key="threshold_quantity">Threshold Quantity:</label>
                                    <input type="number" id="low-stock-threshold" min="1" max="100" value="5" class="w-20 px-3 py-2 border border-slate-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <span class="text-sm text-gray-500" data-lang-key="units">units</span>
                                </div>
                                <button id="save-low-stock-threshold" class="mt-3 btn-primary py-2 px-4 text-sm" data-lang-key="save_threshold">
                                    Save Threshold
                                </button>
                                <p id="threshold-status" class="text-sm text-center mt-2"></p>
                            </div>

                        </div>

                         <!-- NEW: Change Credentials Section -->
                        <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                            <h3 class="text-lg font-medium text-gray-700" data-lang-key="settings_credentials">Change Login Credentials</h3>
                             <p class="text-sm text-gray-500 mb-3" data-lang-key="settings_credentials_desc">Update your username and password.</p>
                            <div class="space-y-4">
                                <div>
                                    <label for="new-username" class="block text-sm font-medium text-gray-600" data-lang-key="settings_new_user">New Username</label>
                                     <!-- Orange theme -->
                                    <input type="text" id="new-username" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label for="new-password" class="block text-sm font-medium text-gray-600" data-lang-key="settings_new_pass">New Password</label>
                                     <!-- Orange theme -->
                                    <input type="password" id="new-password" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label for="confirm-password" class="block text-sm font-medium text-gray-600" data-lang-key="settings_confirm_pass">Confirm Password</label>
                                     <!-- Orange theme -->
                                    <input type="password" id="confirm-password" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>
                                <!-- Orange theme -->
                                <button id="save-credentials-btn" class="w-full btn-primary py-3 px-4" data-lang-key="settings_save_creds">
                                    Save Credentials
                                </button>
                                <p id="credential-status" class="text-sm text-center mt-2"></p>
                            </div>
                        </div>

                        <!-- NEW: Clear Data Section -->
                         <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                             <h3 class="text-lg font-medium text-red-700" data-lang-key="settings_clear_data">Clear All Data</h3>
                             <p class="text-sm text-gray-500 mb-3" data-lang-key="settings_clear_desc">This will permanently delete all customers, products, and purchase orders. This action cannot be undone.</p>
                            <button id="clear-data-btn" class="w-full btn-danger py-3 px-4" data-lang-key="settings_clear_button">
                                Clear All Application Data
                            </button>
                        </div>
                    </div>
                </div>

            </main>
        </div>

        <!-- Bottom Navigation (Mobile) -->
        <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around shadow-inner z-50">
            <!-- Orange theme -->
            <a href="#" id="nav-mobile-dashboard" class="nav-link-mobile flex-1 flex flex-col items-center p-2 text-orange-600">
                <i data-lucide="layout-dashboard" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                <span class="text-xs font-medium" data-lang-key="nav_dashboard">Dashboard</span>
            </a>
            <a href="#" id="nav-mobile-customers" class="nav-link-mobile flex-1 flex flex-col items-center p-2 text-gray-500">
                <i data-lucide="users" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                <span class="text-xs font-medium" data-lang-key="nav_customers">Customers</span>
            </a>
            <a href="#" id="nav-mobile-billing" class="nav-link-mobile flex-1 flex flex-col items-center p-2 text-gray-500">
                <i data-lucide="receipt" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                <span class="text-xs font-medium" data-lang-key="nav_billing">Billing</span>
            </a>
            <a href="#" id="nav-mobile-products" class="nav-link-mobile flex-1 flex flex-col items-center p-2 text-gray-500">
                <i data-lucide="package" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                <span class="text-xs font-medium" data-lang-key="nav_products">Products</span>
            </a>
            <a href="#" id="nav-mobile-assistant" class="nav-link-mobile flex-1 flex flex-col items-center p-2 text-gray-500">
                <i data-lucide="brain-circuit" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                <span class="text-xs font-medium" data-lang-key="nav_assistant">Assistant</span>
            </a>
            <a href="#" id="nav-mobile-settings" class="nav-link-mobile flex-1 flex flex-col items-center p-2 text-gray-500">
                <i data-lucide="settings" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                <span class="text-xs font-medium" data-lang-key="nav_settings">Settings</span>
            </a>
        </nav>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 mx-4">
            <h2 class="text-2xl font-bold text-gray-800" data-lang-key="modal_title">Record Payment</h2>
            <p class="mt-2 text-gray-600">Customer: <span id="modal-customer-name" class="font-semibold"></span></p>
            <p class="mt-1 text-gray-600">Current Balance: <span id="modal-current-balance" class="font-semibold"></span></p>
            
            <div class="mt-4">
                <label for="modal-payment-amount" class="block text-sm font-medium text-gray-600" data-lang-key="modal_amount">Payment Amount (₹)</label>
                <!-- Orange theme -->
                <input type="number" id="modal-payment-amount" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="e.g., 50">
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="btn-secondary" data-lang-key="modal_cancel">Cancel</button>
                <!-- Orange theme -->
                <button id="modal-save-payment-btn" class="btn-primary py-2 px-4" data-lang-key="modal_save">Save Payment</button>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="add-customer-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 mx-4">
            <h2 class="text-2xl font-bold text-gray-800" data-lang-key="add_customer_title">Add New Customer</h2>
            <div class="mt-4 space-y-4">
                <div>
                    <label for="new-customer-name" class="block text-sm font-medium text-gray-600" data-lang-key="form_customer_name">Customer Name</label>
                    <input type="text" id="new-customer-name" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Enter customer name">
                </div>
                <div>
                    <label for="new-customer-phone" class="block text-sm font-medium text-gray-600" data-lang-key="form_phone">Phone Number</label>
                    <input type="tel" id="new-customer-phone" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Enter phone number">
                </div>
                <div>
                    <label for="new-customer-email" class="block text-sm font-medium text-gray-600" data-lang-key="form_email">Email (Optional)</label>
                    <input type="email" id="new-customer-email" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Enter email address">
                </div>
                <div>
                    <label for="new-customer-address" class="block text-sm font-medium text-gray-600" data-lang-key="form_address">Address (Optional)</label>
                    <textarea id="new-customer-address" rows="3" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Enter address"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-customer-btn" class="btn-secondary" data-lang-key="modal_cancel">Cancel</button>
                <button id="save-add-customer-btn" class="btn-primary py-2 px-4" data-lang-key="modal_save">Save Customer</button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="add-product-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 mx-4">
            <h2 class="text-2xl font-bold text-gray-800" data-lang-key="add_product_title">Add New Product</h2>
            <div class="mt-4 space-y-4 max-h-[70vh] overflow-y-auto">
                <div>
                    <label for="new-product-name" class="block text-sm font-medium text-gray-600" data-lang-key="form_product_name">Product Name</label>
                    <input type="text" id="new-product-name" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label for="new-product-barcode" class="block text-sm font-medium text-gray-600">Barcode</label>
                    <div class="flex space-x-2">
                        <input type="text" id="new-product-barcode" placeholder="Enter product barcode" class="mt-1 block flex-1 bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <button id="add-product-scanner-btn" class="mt-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-1" title="Scan Barcode">
                            <i data-lucide="scan-line" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Scan</span>
                        </button>
                    </div>
                </div>
                <div class="flex justify-center items-center h-32 bg-slate-100 rounded-lg border border-slate-300 relative">
                    <img id="new-product-image-preview" src="https://placehold.co/128x128/e0e7ff/6366f1?text=Image" alt="Product Image Preview" class="h-full w-full object-contain rounded-lg">
                    <button id="new-product-image-btn" class="absolute inset-0 w-full h-full bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-200 rounded-lg flex items-center justify-center text-white font-medium">
                        <i data-lucide="camera" class="w-8 h-8"></i>
                    </button>
                    <input type="file" id="new-product-image-input" accept="image/*" class="hidden">
                </div>
                <div>
                    <label for="new-product-unit" class="block text-sm font-medium text-gray-600" data-lang-key="form_unit">Unit</label>
                    <select id="new-product-unit" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="kg" data-lang-key="unit_kg">Kilogram (kg)</option>
                        <option value="g" data-lang-key="unit_g">Gram (g)</option>
                        <option value="l" data-lang-key="unit_l">Liter (l)</option>
                        <option value="ml" data-lang-key="unit_ml">Milliliter (ml)</option>
                        <option value="pcs" data-lang-key="unit_pcs">Pieces (pcs)</option>
                        <option value="box" data-lang-key="unit_box">Box</option>
                        <option value="pack" data-lang-key="unit_pack">Pack</option>
                    </select>
                </div>
                <div>
                    <label for="new-product-stock" class="block text-sm font-medium text-gray-600" data-lang-key="form_stock">Initial Stock</label>
                    <input type="number" id="new-product-stock" value="0" min="0" step="0.01" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label for="new-product-cost-price" class="block text-sm font-medium text-gray-600" data-lang-key="form_cost_price">Cost Price (₹)</label>
                    <input type="number" id="new-product-cost-price" value="0" min="0" step="0.01" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label for="new-product-selling-price" class="block text-sm font-medium text-gray-600" data-lang-key="form_selling_price">Selling Price (₹)</label>
                    <input type="number" id="new-product-selling-price" value="0" min="0" step="0.01" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label for="new-product-mfg" class="block text-sm font-medium text-gray-600" data-lang-key="form_mfg_date">Manufacturing Date</label>
                    <input type="date" id="new-product-mfg" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label for="new-product-exp" class="block text-sm font-medium text-gray-600" data-lang-key="form_exp_date">Expiry Date</label>
                    <input type="date" id="new-product-exp" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-product-btn" class="btn-secondary" data-lang-key="modal_cancel">Cancel</button>
                <button id="save-add-product-btn" class="btn-primary py-2 px-4" data-lang-key="modal_save">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="edit-product-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 mx-4">
            <h2 class="text-2xl font-bold text-gray-800" data-lang-key="manual_title_product">Edit Product</h2>
            <div class="mt-4 space-y-4 max-h-[70vh] overflow-y-auto">
                <div>
                    <label for="edit-product-name" class="block text-sm font-medium text-gray-600" data-lang-key="form_product_name">Product Name</label>
                    <!-- Orange theme -->
                    <input type="text" id="edit-product-name" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div class="flex justify-center items-center h-32 bg-slate-100 rounded-lg border border-slate-300 relative">
                    <img id="edit-product-image-preview" src="https://placehold.co/128x128/e0e7ff/6366f1?text=Image" alt="Product Image Preview" class="h-full w-full object-contain rounded-lg">
                </div>
                <div>
                    <label for="edit-product-unit" class="block text-sm font-medium text-gray-600" data-lang-key="form_unit">Unit</label>
                    <!-- Orange theme -->
                    <select id="edit-product-unit" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="piece" data-lang-key="unit_piece">piece</option>
                        <option value="kg" data-lang-key="unit_kg">kg</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label id="edit-product-stock-label" for="edit-product-stock" class="block text-sm font-medium text-gray-600" data-lang-key="form_stock">Stock Entry</label>
                        <!-- Orange theme -->
                        <input type="number" id="edit-product-stock" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label for="edit-product-cost-price" class="block text-sm font-medium text-gray-600" data-lang-key="form_cost_price">Cost Price (₹)</label>
                        <!-- Orange theme -->
                        <input type="number" id="edit-product-cost-price" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                <div>
                    <label id="edit-product-selling-price-label" for="edit-product-selling-price" class="block text-sm font-medium text-gray-600" data-lang-key="form_selling_price">Selling Price (₹)</label>
                    <!-- Orange theme -->
                    <input type="number" id="edit-product-selling-price" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-product-mfg" class="block text-sm font-medium text-gray-600" data-lang-key="form_mfg">MFG Date</label>
                        <!-- Orange theme -->
                        <input type="date" id="edit-product-mfg" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label for="edit-product-exp" class="block text-sm font-medium text-gray-600" data-lang-key="form_exp">Expiry Date</label>
                        <!-- Orange theme -->
                        <input type="date" id="edit-product-exp" class="mt-1 block w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel-edit-product-btn" class="btn-secondary" data-lang-key="modal_cancel">Cancel</button>
                <!-- Orange theme -->
                <button id="modal-save-product-btn" class="btn-primary py-2 px-4" data-lang-key="modal_save">Save Changes</button>
            </div>
        </div>
    </div>

     <!-- NEW: Custom Confirmation Modal -->
    <div id="confirm-modal" class="confirm-modal hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 mx-4">
            <h2 id="confirm-modal-title" class="text-xl font-bold text-gray-800">Confirm Action</h2>
            <p id="confirm-modal-text" class="mt-2 text-gray-600">Are you sure?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="confirm-modal-cancel-btn" class="btn-secondary" data-lang-key="modal_cancel">Cancel</button>
                <button id="confirm-modal-ok-btn" class="btn-danger py-2 px-4">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Global State ---
        let customers = [];
        let products = [];
        let purchaseOrders = [];
        let transactions = [];
        let currentLanguage = 'en-US'; // 'en-US' or 'hi-IN'
        let currentView = 'dashboard'; 
        let imageFetchTimer;
        // REMOVED: currentManualTab
        let currentPOItems = [];
        let currentBillItems = [];
        const EXPIRY_DAYS_THRESHOLD = 3; 

        // Pagination State
        let customerCurrentPage = 1;
        let productCurrentPage = 1;
        const ITEMS_PER_PAGE = 50; 

        // Backend API Configuration (Auth Only)
        const API_BASE_URL = 'https://inventory-management-backend-fhyr.onrender.com';
        let authToken = null;
        let isAuthenticated = false;
        let currentUser = null;

        // Simulated Credentials (Not Secure!)
        let currentUsername = 'xyz';
        let currentPassword = '123456';

        // --- UI Text Translations ---
        // FIX: Added quotes around all keys
        const uiText = {
            'en-US': {
                "erp_title": "Grocery ERP Login",
                "erp_title_short": "Grocer ERP",
                "nav_dashboard": "Dashboard",
                "nav_customers": "Customers",
                "nav_billing": "Billing",
                "nav_products": "Products",
                "nav_purchase": "Purchase",
                "nav_assistant": "Assistant",
                "nav_settings": "Settings",
                "mode_manual": "Manual",
                "mode_auto": "Automatic",
                "assistant_title": "Assistant",
                "status_ready": "Ready",
                "status_listening": "Listening...",
                "status_processing": "Processing...",
                "status_error": "Error: ",
                "welcome_msg_listening": "Hello! I am listening.",
                "placeholder_message": "Type your message or command...",
                "placeholder_search_customer": "Search customers...",
                "placeholder_search_product": "Search products...",
                "form_name": "Customer Name",
                "form_balance": "Balance Due (₹)",
                "credit_balance": "Credit",
                "form_products": "Products (comma-separated)",
                "placeholder_products": "e.g., Milk, Eggs, Bread",
                "form_save_customer": "Save Customer",
                "manual_title_product": "Product Details",
                "form_product_name": "Product Name",
                "form_stock": "Stock",
                "form_stock_piece": "Stock (in pieces)",
                "form_stock_kg": "Stock (in kg)",
                "form_unit": "Unit",
                "unit_piece": "piece",
                "unit_kg": "kg",
                "unit_g": "g",
                "unit_pcs": "pcs",
                "form_cost_price": "Cost Price (₹)",
                "form_selling_price": "Selling Price (₹)",
                "form_selling_price_piece": "Selling Price (per piece)",
                "form_selling_price_kg": "Selling Price (per kg)",
                "form_mfg": "MFG Date",
                "form_exp": "Expiry Date",
                "form_save_product": "Save Product",
                "dashboard_title_dashboard": "Dashboard",
                "dashboard_title_customers": "Customers",
                "dashboard_title_billing": "Billing",
                "dashboard_title_products": "Products Management",
                "dashboard_title_purchase": "Purchase Orders",
                "dashboard_title_assistant": "AI Assistant",
                "dashboard_title_settings": "Settings",
                "db_status_local": "Data is local (will reset on refresh)",
                "no_customers": "No customers found.",
                "no_products": "No products found.",
                "placeholder_soon": "This section is coming soon.",
                "form_name_required": "Customer name is required.",
                "form_product_name_required": "Product name is required.",
                "ai_parse_error": "Sorry, I didn't understand that command. Please try again.",
                "ai_name_missing": "I couldn't understand the name. Please try again.",
                "ai_add_success": "Successfully added customer: ",
                "ai_add_product_success": "Successfully added product: ",
                "ai_save_error": "Error: Could not save.",
                "ai_delete_success": "Successfully deleted customer: ",
                "ai_delete_not_found": "Sorry, I couldn't find a customer named: ",
                "ai_delete_balance_error": "Cannot delete customer with a balance due.",
                "ai_query_balance_prefix": "The balance for ",
                "ai_query_balance_suffix": " is ₹",
                "ai_query_balance_zero": " has no outstanding balance.",
                "ai_query_not_found": "Sorry, I couldn't find: ",
                "ai_query_stock_response_prefix": "There are ",
                "ai_query_stock_response_suffix": " of ",
                "ai_query_stock_response_instock": " in stock.",
                "ai_pay_success_prefix": " paid ₹",
                "ai_pay_success_suffix": ". New balance is ₹",
                "ai_pay_missing_amount": "I understood the customer, but not how much they paid. Please try again.",
                "ai_details_showing": "Showing details for ",
                "ai_bill_created_prefix": "Bill created for ",
                "ai_bill_created_suffix": ". New balance is ",
                "ai_bill_item_not_found": "Sorry, I couldn't find the product: ",
                "ai_bill_no_items": "You need to tell me what items to bill.",
                "ai_bill_stock_error_prefix": "Not enough stock for ",
                "ai_bill_stock_error_suffix": ". Transaction cancelled.",
                "product_list": "Products Purchased:",
                "stock": "Stock",
                "cost_price": "Cost",
                "selling_price": "Price",
                "login_error": "Invalid username or password.",
                "image_placeholder": "Image",
                "card_total_customers": "Total Customers",
                "card_total_products": "Total Products",
                "card_balance_due": "Total Balance Due",
                "card_daily_profit": "Daily Profit",
                "card_monthly_profit": "Monthly Profit",
                "placeholder_note": "(placeholder)",
                "chart_title": "Profit / Loss (Monthly)",
                "placeholder_chart": "Chart placeholder - Full sales tracking needed.",
                "recent_activity_title": "Recent Activity",
                "no_activity": "No recent activity.",
                "po_title": "New Purchase Order",
                "form_supplier": "Supplier Name",
                "form_quantity": "Quantity",
                "form_add_item": "Add Item",
                "form_save_po": "Save Purchase Order",
                "po_list_title": "Past Purchase Orders",
                "no_po": "No purchase orders found.",
                "select_product": "Select a product...",
                "po_item_added": "Item added to PO.",
                "po_item_removed": "Item removed.",
                "po_saved": "Purchase Order saved.",
                "stock_updated": "Stock updated for ",
                "record_payment": "Record Payment",
                "modal_title": "Record Payment",
                "modal_amount": "Payment Amount (₹)",
                "modal_cancel": "Cancel",
                "modal_save": "Save",
                "settings_title": "Settings",
                "settings_language": "Language",
                "settings_language_desc": "Choose your preferred language for the app.",
                "download_pdf": "Download PDF",
                "expiry_title": "Expiry Alerts",
                "no_expiry": "No products expiring soon.",
                "expires_on": "Expires",
                "billing_title": "New Bill",
                "form_customer": "Customer",
                "select_customer": "Select a customer...",
                "billing_add_item": "Add Item",
                "billing_summary": "Bill Summary",
                "no_items": "No items added to bill.",
                "billing_total": "Total:",
                "billing_finalize": "Finalize Bill",
                "billing_success": "Bill finalized. Customer balance updated.",
                "billing_error_customer": "Please select or enter a customer name.",
                "billing_error_no_items": "Cannot finalize an empty bill.",
                "billing_error_stock": "Not enough stock for: ",
                "settings_clear_data": "Clear All Data",
                "settings_clear_desc": "This will permanently delete all customers, products, and purchase orders. This action cannot be undone.",
                "settings_clear_button": "Clear All Application Data",
                "settings_clear_confirm_title": "Confirm Clear Data",
                "settings_clear_confirm_text": "Are you absolutely sure you want to delete all data?",
                "settings_data_cleared": "All application data has been cleared.",
                
                // New features language keys
                "add_customer": "Add Customer",
                "add_product": "Add Product",
                "add_customer_title": "Add New Customer",
                "add_product_title": "Add New Product",
                "form_customer_name": "Customer Name",
                "form_phone": "Phone Number",
                "form_email": "Email (Optional)",
                "form_address": "Address (Optional)",
                "unit_kg": "Kilogram (kg)",
                "unit_g": "Gram (g)",
                "unit_l": "Liter (l)",
                "unit_ml": "Milliliter (ml)",
                "unit_pcs": "Pieces (pcs)",
                "unit_box": "Box",
                "unit_pack": "Pack",
                "form_mfg_date": "Manufacturing Date",
                "form_exp_date": "Expiry Date",
                
                // Payment methods
                "payment_method": "Payment Method",
                "payment_cash": "Cash",
                "payment_due": "Due",
                
                // Dashboard improvements
                "low_stock_title": "Low Stock Alerts",
                "no_low_stock": "No products with low stock.",
                "quick_stats_title": "Quick Stats",
                "out_of_stock": "Out of Stock",
                "low_stock_items": "Low Stock Items",
                "expiring_soon": "Expiring Soon",
                
                // Reports
                "nav_reports": "Reports",
                "reports_title": "Business Reports",
                "report_period": "Period",
                "period_today": "Today",
                "period_week": "This Week",
                "period_month": "This Month",
                "period_quarter": "This Quarter",
                "period_year": "This Year",
                "report_type": "Report Type",
                "report_sales": "Sales Report",
                "report_profit": "Profit Report",
                "report_inventory": "Inventory Report",
                "report_customers": "Customer Report",
                "report_format": "Format",
                "format_pdf": "PDF",
                "format_excel": "Excel",
                "format_csv": "CSV",
                "generate_report": "Generate Report",
                "report_preview": "Report Preview",
                "select_report_options": "Select report options above to generate preview",
                
                // Upgrade Plan
                "nav_upgrade": "Upgrade Plan",
                "upgrade_title": "Upgrade Your Plan",
                "current_plan": "Current Plan",
                "plan_basic": "Basic Plan - Free",
                "plan_features": "Limited Features",
                "plan_storage": "Local Storage Only",
                "plan_pro": "Pro Plan",
                "plan_enterprise": "Enterprise Plan",
                "feature_unlimited_products": "Unlimited Products",
                "feature_unlimited_customers": "Unlimited Customers",
                "feature_cloud_backup": "Cloud Backup",
                "feature_advanced_reports": "Advanced Reports",
                "feature_priority_support": "Priority Support",
                "feature_all_pro": "Everything in Pro",
                "feature_multi_location": "Multi-Location Support",
                "feature_api_access": "API Access",
                "feature_custom_integrations": "Custom Integrations",
                "feature_dedicated_support": "Dedicated Support",
                "upgrade_to_pro": "Upgrade to Pro",
                "upgrade_to_enterprise": "Upgrade to Enterprise",
                "recharge_warning": "Recharge Running Low",
                "recharge_message": "Your current plan recharge is running low. Consider upgrading to avoid service interruption.",
                
                // Enhanced AI Interface
                "assistant_subtitle": "Your intelligent business companion",
                "assistant_status": "Always available to help",
                "capability_inventory": "Inventory Management",
                "capability_inventory_desc": "Track stock levels",
                "capability_billing": "Smart Billing",
                "capability_billing_desc": "Process transactions",
                "capability_analytics": "Business Analytics",
                "capability_analytics_desc": "Generate insights",
                "ai_name": "AI Assistant",
                "ai_status": "Online",
                "clear_chat": "Clear Chat",
                "voice_toggle": "Toggle Voice",
                "welcome_title": "Welcome to AI Assistant!",
                "welcome_desc": "I can help you manage your grocery business efficiently. Here's what I can do:",
                "help_inventory": "Track inventory and stock levels",
                "help_billing": "Process customer bills and payments",
                "help_reports": "Generate business reports",
                "help_customers": "Manage customer information",
                "welcome_ask": "Ask me anything about your business!",
                "input_hint": "Press Enter to send, or click the microphone for voice input",
                "typing": "Typing...",
                "settings_credentials": "Change Login Credentials",
                "settings_credentials_desc": "Update your username and password.",
                "settings_new_user": "New Username",
                "settings_new_pass": "New Password",
                "settings_confirm_pass": "Confirm Password",
                "settings_save_creds": "Save Credentials",
                "settings_creds_updated": "Credentials updated successfully.",
                "settings_pass_mismatch": "Passwords do not match.",
                "settings_creds_error": "Please fill all credential fields.",
                "settings_low_stock_threshold": "Low Stock Threshold",
                "settings_low_stock_desc": "Set the minimum stock quantity to trigger low stock alerts.",
                "threshold_quantity": "Threshold Quantity:",
                "units": "units",
                "save_threshold": "Save Threshold",
                "threshold_saved": "Low stock threshold saved successfully.",
                "threshold_error": "Please enter a valid threshold value."
            },
            'hi-IN': {
                "erp_title": "किराना ईआरपी लॉगिन",
                "erp_title_short": "किराना ईआरपी",
                "nav_dashboard": "डैशबोर्ड",
                "nav_customers": "ग्राहक",
                "nav_billing": "बिलिंग",
                "nav_products": "उत्पाद",
                "nav_purchase": "खरीद",
                "nav_assistant": "सहायक",
                "nav_settings": "सेटिंग्स",
                "mode_manual": "मैनुअल",
                "mode_auto": "स्वचालित",
                "assistant_title": "सहायक",
                "status_ready": "तैयार",
                "status_listening": "सुन रहा हूँ...",
                "status_processing": "प्रोसेस हो रहा है...",
                "status_error": "त्रुटि: ",
                "welcome_msg_listening": "नमस्ते! मैं सुन रहा हूँ।",
                "placeholder_message": "अपना संदेश या कमांड टाइप करें...",
                "placeholder_search_customer": "ग्राहक खोजें...",
                "placeholder_search_product": "उत्पाद खोजें...",
                "form_name": "ग्राहक का नाम",
                "form_balance": "बकाया राशि (₹)",
                "credit_balance": "क्रेडिट",
                "form_products": "उत्पाद (अल्पविराम से अलग)",
                "placeholder_products": "जैसे, दूध, अंडे, ब्रेड",
                "form_save_customer": "ग्राहक सहेजें",
                "manual_title_product": "उत्पाद विवरण",
                "form_product_name": "उत्पाद का नाम",
                "form_stock": "स्टॉक",
                "form_stock_piece": "स्टॉक (पीस में)",
                "form_stock_kg": "स्टॉक (किलो में)",
                "form_unit": "इकाई",
                "unit_piece": "पीस",
                "unit_kg": "किलो",
                "unit_g": "ग्राम",
                "unit_pcs": "पीस",
                "form_cost_price": "लागत मूल्य (₹)",
                "form_selling_price": "बिक्री मूल्य (₹)",
                "form_selling_price_piece": "बिक्री मूल्य (प्रति पीस)",
                "form_selling_price_kg": "बिक्री मूल्य (प्रति किलो)",
                "form_mfg": "MFG दिनांक",
                "form_exp": "EXP दिनांक",
                "form_save_product": "उत्पाद सहेजें",
                "dashboard_title_dashboard": "डैशबोर्ड",
                "dashboard_title_customers": "ग्राहक",
                "dashboard_title_billing": "बिलिंग",
                "dashboard_title_products": "उत्पाद प्रबंधन",
                "dashboard_title_purchase": "खरीद आदेश",
                "dashboard_title_assistant": "एआई सहायक",
                "dashboard_title_settings": "सेटिंग्स",
                "db_status_local": "डेटा स्थानीय है (रिफ्रेश पर रीसेट हो जाएगा)",
                "no_customers": "कोई ग्राहक नहीं मिला।",
                "no_products": "कोई उत्पाद नहीं मिला।",
                "placeholder_soon": "यह अनुभाग जल्द ही आ रहा है।",
                "form_name_required": "ग्राहक का नाम आवश्यक है।",
                "form_product_name_required": "उत्पाद का नाम आवश्यक है।",
                "ai_parse_error": "माफ़ कीजिए, मैं वह कमांड समझ नहीं पाया। कृपया पुनः प्रयास करें।",
                "ai_name_missing": "मैं नाम नहीं समझ सका। कृपया पुनः प्रयास करें।",
                "ai_add_success": "ठीक है, ग्राहक को जोड़ दिया गया है: ",
                "ai_add_product_success": "बढ़िया, उत्पाद जोड़ दिया गया है: ",
                "ai_save_error": "त्रुटि: सहेजा नहीं जा सका।",
                "ai_delete_success": "ग्राहक को हटा दिया गया है: ",
                "ai_delete_not_found": "माफ़ कीजिए, मुझे नाम का कोई ग्राहक नहीं मिला: ",
                "ai_delete_balance_error": "जिस ग्राहक का बैलेंस बकाया है, उसे डिलीट नहीं किया जा सकता।",
                "ai_query_balance_prefix": "के ",
                "ai_query_balance_suffix": " रुपये बाकी हैं।",
                "ai_query_balance_zero": " का कोई हिसाब बाकी नहीं है (₹0).",
                "ai_query_not_found": "माफ़ कीजिए, मुझे यह नहीं मिला: ",
                "ai_query_stock_response_prefix": "स्टॉक में ",
                "ai_query_stock_response_suffix": " के ",
                "ai_query_stock_response_instock": " यूनिट हैं।",
                "ai_pay_success_prefix": " ने ₹",
                "ai_pay_success_suffix": " जमा कर दिए। उनका नया बैलेंस है ₹",
                "ai_pay_missing_amount": "मैं ग्राहक को समझ गया, लेकिन यह नहीं कि उन्होंने कितना भुगतान किया। कृपया पुनः प्रयास करें।",
                "ai_details_showing": "के लिए विवरण दिखा रहा हूँ ",
                "ai_bill_created_prefix": "के लिए बिल बन गया है (कुल ₹",
                "ai_bill_created_suffix": "). उनका नया बैलेंस है ",
                "ai_bill_item_not_found": "माफ़ कीजिए, मुझे यह उत्पाद नहीं मिला: ",
                "ai_bill_no_items": "आपको मुझे बताना होगा कि किन वस्तुओं का बिल बनाना है।",
                "ai_bill_stock_error_prefix": "के लिए पर्याप्त स्टॉक नहीं है: ",
                "ai_bill_stock_error_suffix": ". सौदा रद्द कर दिया गया।",
                "product_list": "खरीदे गए उत्पाद:",
                "stock": "स्टॉक",
                "cost_price": "लागत",
                "selling_price": "मूल्य",
                "login_error": "अमान्य उपयोगकर्ता नाम या पासवर्ड।",
                "image_placeholder": "छवि",
                "card_total_customers": "कुल ग्राहक",
                "card_total_products": "कुल उत्पाद",
                "card_balance_due": "कुल बकाया",
                "card_daily_profit": "दैनिक लाभ",
                "card_monthly_profit": "मासिक लाभ",
                "placeholder_note": "(प्लेसहोल्डर)",
                "chart_title": "लाभ / हानि (मासिक)",
                "placeholder_chart": "चार्ट प्लेसहोल्डर - पूर्ण बिक्री ट्रैकिंग की आवश्यकता है।",
                "recent_activity_title": "हाल की गतिविधि",
                "no_activity": "कोई हाल की गतिविधि नहीं।",
                "po_title": "नया खरीद आदेश",
                "form_supplier": "आपूर्तिकर्ता का नाम",
                "form_quantity": "मात्रा",
                "form_add_item": "आइटम जोड़ें",
                "form_save_po": "खरीद आदेश सहेजें",
                "po_list_title": "पिछले खरीद आदेश",
                "no_po": "कोई खरीद आदेश नहीं मिला।",
                "select_product": "एक उत्पाद चुनें...",
                "po_item_added": "आइटम पीओ में जोड़ा गया।",
                "po_item_removed": "आइटम हटाया गया।",
                "po_saved": "खरीद आदेश सहेजा गया।",
                "stock_updated": "के लिए स्टॉक अपडेट किया गया ",
                "record_payment": "भुगतान रिकॉर्ड करें",
                "modal_title": "भुगतान रिकॉर्ड करें",
                "modal_amount": "भुगतान राशि (₹)",
                "modal_cancel": "रद्द करें",
                "modal_save": "सहेजें",
                "settings_title": "सेटिंग्स",
                "settings_language": "भाषा",
                "settings_language_desc": "ऐप के लिए अपनी पसंदीदा भाषा चुनें।",
                "download_pdf": "पीडीएफ डाउनलोड करें",
                "expiry_title": "समाप्ति अलर्ट",
                "no_expiry": "कोई उत्पाद जल्द ही समाप्त नहीं हो रहा है।",
                "expires_on": "समाप्त",
                "billing_title": "नया बिल",
                "form_customer": "ग्राहक",
                "select_customer": "एक ग्राहक चुनें...",
                "billing_add_item": "आइटम जोड़ें",
                "billing_summary": "बिल सारांश",
                "no_items": "बिल में कोई आइटम नहीं जोड़ा गया।",
                "billing_total": "कुल:",
                "billing_finalize": "बिल को अंतिम रूप दें",
                "billing_success": "बिल को अंतिम रूप दिया गया। ग्राहक का बैलेंस अपडेट किया गया।",
                "billing_error_customer": "कृपया एक ग्राहक चुनें या दर्ज करें।",
                "billing_error_no_items": "खाली बिल को अंतिम रूप नहीं दिया जा सकता।",
                "billing_error_stock": "के लिए पर्याप्त स्टॉक नहीं है: ",
                "settings_clear_data": "सारा डेटा साफ़ करें",
                "settings_clear_desc": "यह सभी ग्राहकों, उत्पादों और खरीद आदेशों को स्थायी रूप से हटा देगा। यह कार्रवाई पूर्ववत नहीं की जा सकती।",
                "settings_clear_button": "सभी एप्लिकेशन डेटा साफ़ करें",
                "settings_clear_confirm_title": "डेटा साफ़ करने की पुष्टि करें",
                "settings_clear_confirm_text": "क्या आप वाकई सारा डेटा हटाना चाहते हैं?",
                "settings_data_cleared": "सभी एप्लिकेशन डेटा साफ़ कर दिया गया है।",
                "settings_credentials": "लॉगिन क्रेडेंशियल बदलें",
                "settings_credentials_desc": "अपना उपयोगकर्ता नाम और पासवर्ड अपडेट करें।",
                "settings_new_user": "नया उपयोगकर्ता नाम",
                "settings_new_pass": "नया पासवर्ड",
                "settings_confirm_pass": "पासवर्ड की पुष्टि करें",
                "settings_save_creds": "क्रेडेंशियल सहेजें",
                "settings_creds_updated": "क्रेडेंशियल सफलतापूर्वक अपडेट किए गए।",
                "settings_pass_mismatch": "पासवर्ड मेल नहीं खाते।",
                "settings_creds_error": "कृपया क्रेडेंशियल के सभी फ़ील्ड भरें।",
                "settings_low_stock_threshold": "कम स्टॉक सीमा",
                "settings_low_stock_desc": "कम स्टॉक अलर्ट ट्रिगर करने के लिए न्यूनतम स्टॉक मात्रा सेट करें।",
                "threshold_quantity": "सीमा मात्रा:",
                "units": "यूनिट",
                "save_threshold": "सीमा सेव करें",
                "threshold_saved": "कम स्टॉक सीमा सफलतापूर्वक सेव हो गई।",
                "threshold_error": "कृपया एक वैध सीमा मान दर्ज करें।"
            }
        };


        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const signupScreen = document.getElementById('signup-screen');
        const erpApp = document.getElementById('erp-app');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const displayUsername = document.getElementById('display-username'); 

        // Signup Form Elements
        const signupForm = document.getElementById('signup-form');
        const otpForm = document.getElementById('otp-form');
        const signupBtn = document.getElementById('signup-btn');
        const signupError = document.getElementById('signup-error');
        const signupNameInput = document.getElementById('signup-name');
        const signupEmailInput = document.getElementById('signup-email');
        const signupMobileInput = document.getElementById('signup-mobile');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
        const showLoginBtn = document.getElementById('show-login-btn');
        const showSignupBtn = document.getElementById('show-signup-btn');
        
        // OTP Form Elements
        const otpInput = document.getElementById('otp-input');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const resendOtpBtn = document.getElementById('resend-otp-btn');
        const otpError = document.getElementById('otp-error');
        const otpEmailSpan = document.getElementById('otp-email');
        const backToSignupBtn = document.getElementById('back-to-signup-btn'); 

        // AI Assistant Page
        const chatLog = document.getElementById('chat-log');
        const status = document.getElementById('status');
        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const loadingIndicator = document.getElementById('loading');
        
        // Mode Toggles (Hidden)
        const modeToggle = document.getElementById('mode-toggle');
        
        // Lang Toggles
        const langToggle = document.getElementById('lang-toggle-settings');
        const langEnLabel = document.getElementById('lang-en-label-settings');
        const langHiLabel = document.getElementById('lang-hi-label-settings');
        const langToggleMobile = document.getElementById('lang-toggle-mobile'); 

        // REMOVED: Add Entry Elements

        // Data Views
        const headerTitle = document.getElementById('header-title');
        const customerList = document.getElementById('customer-list');
        const customerListPlaceholder = document.getElementById('customer-list-placeholder');
        const productList = document.getElementById('product-list');
        const productListPlaceholder = document.getElementById('product-list-placeholder');
        
        // Search
        const customerSearchInput = document.getElementById('customer-search');
        const productSearchInput = document.getElementById('product-search');
        
        // Navigation
        const navLinks = document.querySelectorAll('.nav-link');
        const navLinksMobile = document.querySelectorAll('.nav-link-mobile');
        const dataViews = document.querySelectorAll('.data-view');

        // Dashboard
        const dashboardTotalCustomers = document.getElementById('dashboard-total-customers');
        const dashboardTotalProducts = document.getElementById('dashboard-total-products');
        const dashboardTotalBalance = document.getElementById('dashboard-total-balance');
        const dashboardDailyProfit = document.getElementById('dashboard-daily-profit'); 
        const dashboardMonthlyProfit = document.getElementById('dashboard-monthly-profit'); // <-- FIX: Added this line
        const recentActivityList = document.getElementById('recent-activity-list');
        const recentActivityPlaceholder = document.getElementById('recent-activity-placeholder');
        const expiryAlertList = document.getElementById('expiry-alert-list'); 
        const expiryAlertPlaceholder = document.getElementById('expiry-alert-placeholder'); 

        // Purchase Order
        const poSupplier = document.getElementById('po-supplier');
        const poProductSelect = document.getElementById('po-product');
        const poQty = document.getElementById('po-qty');
        const poCost = document.getElementById('po-cost');
        const addPOItemBtn = document.getElementById('add-po-item-btn');
        const savePOBtn = document.getElementById('save-po-btn');
        const poItemsList = document.getElementById('po-items-list');
        const poList = document.getElementById('po-list');
        const poListPlaceholder = document.getElementById('po-list-placeholder');

        // Billing
        const billingCustomerSearch = document.getElementById('billing-customer-search'); 
        const customerDatalist = document.getElementById('customer-datalist'); 
        const billingCustomerName = document.getElementById('billing-customer-name'); 
        const billingProductSelect = document.getElementById('billing-product');
        const billingQtyInput = document.getElementById('billing-qty');
        const billingUnitSelect = document.getElementById('billing-unit'); 
        const addToBillBtn = document.getElementById('add-to-bill-btn');
        const billingItemsList = document.getElementById('billing-items-list');
        const billingItemsPlaceholder = document.getElementById('billing-items-placeholder');
        const billingTotal = document.getElementById('billing-total');
        const finalizeBillBtn = document.getElementById('finalize-bill-btn');
        const billingStatus = document.getElementById('billing-status');

        // Payment Modal
        const paymentModal = document.getElementById('payment-modal');
        const modalCustomerName = document.getElementById('modal-customer-name');
        const modalCurrentBalance = document.getElementById('modal-current-balance');
        const modalPaymentAmount = document.getElementById('modal-payment-amount');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalSavePaymentBtn = document.getElementById('modal-save-payment-btn');

        // Edit Product Modal
        const editProductModal = document.getElementById('edit-product-modal');
        const editProductNameInput = document.getElementById('edit-product-name');
        const editProductImagePreview = document.getElementById('edit-product-image-preview');
        const editProductUnitInput = document.getElementById('edit-product-unit');
        const editProductStockInput = document.getElementById('edit-product-stock');
        const editProductCostPriceInput = document.getElementById('edit-product-cost-price');
        const editProductSellingPriceInput = document.getElementById('edit-product-selling-price');
        const editProductMfgInput = document.getElementById('edit-product-mfg');
        const editProductExpInput = document.getElementById('edit-product-exp');
        const editProductStockLabel = document.getElementById('edit-product-stock-label');
        const editProductSellingPriceLabel = document.getElementById('edit-product-selling-price-label');
        const modalSaveProductBtn = document.getElementById('modal-save-product-btn');
        const modalCancelEditProductBtn = document.getElementById('modal-cancel-edit-product-btn');

        // PDF Download Buttons
        const downloadCustomersBtn = document.getElementById('download-customers-pdf');
        const downloadProductsBtn = document.getElementById('download-products-pdf');

        // Add Customer and Product Buttons
        const addCustomerBtn = document.getElementById('add-customer-btn');
        const addProductBtn = document.getElementById('add-product-btn');
        
        // Add Customer Modal Elements
        const addCustomerModal = document.getElementById('add-customer-modal');
        const newCustomerNameInput = document.getElementById('new-customer-name');
        const newCustomerPhoneInput = document.getElementById('new-customer-phone');
        const newCustomerEmailInput = document.getElementById('new-customer-email');
        const newCustomerAddressInput = document.getElementById('new-customer-address');
        const saveAddCustomerBtn = document.getElementById('save-add-customer-btn');
        const cancelAddCustomerBtn = document.getElementById('cancel-add-customer-btn');
        
        // Add Product Modal Elements
        const addProductModal = document.getElementById('add-product-modal');
        const newProductNameInput = document.getElementById('new-product-name');
        const newProductUnitInput = document.getElementById('new-product-unit');
        const newProductStockInput = document.getElementById('new-product-stock');
        const newProductCostPriceInput = document.getElementById('new-product-cost-price');
        const newProductSellingPriceInput = document.getElementById('new-product-selling-price');
        const newProductMfgInput = document.getElementById('new-product-mfg');
        const newProductExpInput = document.getElementById('new-product-exp');
        const saveAddProductBtn = document.getElementById('save-add-product-btn');
        const cancelAddProductBtn = document.getElementById('cancel-add-product-btn');

        // Pagination Buttons
        const customerPrevBtn = document.getElementById('customer-prev-btn');
        const customerNextBtn = document.getElementById('customer-next-btn');
        const customerPageInfo = document.getElementById('customer-page-info');
        const productPrevBtn = document.getElementById('product-prev-btn');
        const productNextBtn = document.getElementById('product-next-btn');
        const productPageInfo = document.getElementById('product-page-info');

        // Settings - Clear Data
        const clearDataBtn = document.getElementById('clear-data-btn'); 

        // Settings - Credentials
        const newUsernameInput = document.getElementById('new-username'); 
        const newPasswordInput = document.getElementById('new-password'); 
        const confirmPasswordInput = document.getElementById('confirm-password'); 
        const saveCredentialsBtn = document.getElementById('save-credentials-btn'); 
        const credentialStatus = document.getElementById('credential-status'); 

        // Confirmation Modal
        const confirmModal = document.getElementById('confirm-modal'); 
        const confirmModalTitle = document.getElementById('confirm-modal-title'); 
        const confirmModalText = document.getElementById('confirm-modal-text'); 
        const confirmModalOkBtn = document.getElementById('confirm-modal-ok-btn'); 
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn'); 
        let confirmCallback = null; 


        // --- UI Update Functions ---
        
        lucide.createIcons();
        
        // Initialize time display
        function updateCurrentTime() {
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateString = now.toLocaleDateString();
                timeElement.textContent = `${dateString} ${timeString}`;
            }
        }
        
        // Update time every second
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime(); // Initial call
        
        // Subscription System
        let subscriptionData = {
            isActive: true,
            expiryDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days from now
            planType: 'premium'
        };
        
        // Load subscription data from localStorage
        const savedSubscription = localStorage.getItem('subscriptionData');
        if (savedSubscription) {
            subscriptionData = JSON.parse(savedSubscription);
            subscriptionData.expiryDate = new Date(subscriptionData.expiryDate);
        }
        
        function updateSubscriptionStatus() {
            const now = new Date();
            const daysLeft = Math.ceil((subscriptionData.expiryDate - now) / (1000 * 60 * 60 * 24));
            
            const subscriptionStatus = document.getElementById('subscription-status');
            const subscriptionDays = document.getElementById('subscription-days');
            
            if (subscriptionStatus && subscriptionDays) {
                if (daysLeft > 0) {
                    subscriptionStatus.classList.remove('hidden');
                    subscriptionDays.textContent = `${daysLeft} days left`;
                    
                    // Color changing logic
                    subscriptionStatus.className = subscriptionStatus.className.replace(/bg-(green|orange|red)-100/g, '');
                    subscriptionDays.className = subscriptionDays.className.replace(/text-(green|orange|red)-700/g, '');
                    
                    if (daysLeft > 20) {
                        // Green for 30+ days
                        subscriptionStatus.classList.add('bg-green-100');
                        subscriptionDays.classList.add('text-green-700');
                    } else if (daysLeft > 10) {
                        // Orange for 20-10 days
                        subscriptionStatus.classList.add('bg-orange-100');
                        subscriptionDays.classList.add('text-orange-700');
                    } else if (daysLeft > 3) {
                        // Red for 10-3 days
                        subscriptionStatus.classList.add('bg-red-100');
                        subscriptionDays.classList.add('text-red-700');
                    } else {
                        // Critical red for 3 days or less
                        subscriptionStatus.classList.add('bg-red-200', 'border-2', 'border-red-500');
                        subscriptionDays.classList.add('text-red-800', 'font-bold');
                        
                        // Show recharge warning
                        showRechargeWarning();
                    }
                } else {
                    subscriptionStatus.classList.add('hidden');
                    // Subscription expired - lock features
                    lockFeatures();
                }
            }
        }
        
        function showRechargeWarning() {
            // Remove existing warning if any
            const existingWarning = document.getElementById('recharge-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
            
            // Create recharge warning banner
            const warningBanner = document.createElement('div');
            warningBanner.id = 'recharge-warning';
            warningBanner.className = 'fixed top-16 left-0 right-0 bg-gradient-to-r from-red-500 to-red-600 text-white text-center py-3 z-40 shadow-lg';
            warningBanner.innerHTML = `
                <div class="flex items-center justify-center space-x-3">
                    <i data-lucide="alert-triangle" class="w-5 h-5 animate-pulse"></i>
                    <span class="font-semibold">Subscription Expiring Soon!</span>
                    <button onclick="switchView('upgrade')" class="bg-white text-red-600 px-4 py-1 rounded-full font-bold hover:bg-gray-100 transition-colors">
                        Recharge Now
                    </button>
                </div>
            `;
            document.body.appendChild(warningBanner);
            lucide.createIcons();
        }
        
        function lockFeatures() {
            // Disable all navigation except dashboard and recharge
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                if (!link.id.includes('dashboard') && !link.id.includes('upgrade')) {
                    link.classList.add('opacity-50', 'pointer-events-none');
                }
            });
            
            // Show subscription expired message
            const expiredMessage = document.createElement('div');
            expiredMessage.className = 'fixed top-0 left-0 right-0 bg-red-600 text-white text-center py-2 z-50';
            expiredMessage.innerHTML = '<i data-lucide="alert-triangle" class="w-4 h-4 inline mr-2"></i>Subscription Expired! Please recharge to continue using all features.';
            document.body.appendChild(expiredMessage);
            lucide.createIcons();
        }
        
        function unlockFeatures() {
            // Re-enable all navigation
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('opacity-50', 'pointer-events-none');
            });
            
            // Remove expired message
            const expiredMessage = document.querySelector('.fixed.top-0');
            if (expiredMessage) {
                expiredMessage.remove();
            }
        }
        
        function rechargeSubscription(days) {
            subscriptionData.expiryDate = new Date(Date.now() + days * 24 * 60 * 60 * 1000);
            subscriptionData.isActive = true;
            
            // Save to localStorage
            localStorage.setItem('subscriptionData', JSON.stringify(subscriptionData));
            
            // Update UI
            updateSubscriptionStatus();
            unlockFeatures();
            
            // Show success message
            addActivity(`Subscription recharged for ${days} days!`, 'check-circle');
        }
        
        // Initialize subscription status
        updateSubscriptionStatus();
        
        // Chart generation functions
        function generateSalesChart() {
            const ctx = document.getElementById('sales-chart');
            if (!ctx) return;
            
            // Sample data - replace with actual transaction data
            const salesData = transactions.filter(t => t.type === 'sale').slice(-7);
            const labels = salesData.map(t => new Date(t.date).toLocaleDateString());
            const data = salesData.map(t => t.total);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.length > 0 ? labels : ['No Data'],
                    datasets: [{
                        label: 'Sales (₹)',
                        data: data.length > 0 ? data : [0],
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function generateProfitChart() {
            const ctx = document.getElementById('profit-chart');
            if (!ctx) return;
            
            const profitData = transactions.filter(t => t.type === 'sale').slice(-7);
            const labels = profitData.map(t => new Date(t.date).toLocaleDateString());
            const data = profitData.map(t => t.profit || 0);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.length > 0 ? labels : ['No Data'],
                    datasets: [{
                        label: 'Profit (₹)',
                        data: data.length > 0 ? data : [0],
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function generateInventoryChart() {
            const ctx = document.getElementById('inventory-chart');
            if (!ctx) return;
            
            const lowStockCount = products.filter(p => p.stock < 5).length;
            const normalStockCount = products.filter(p => p.stock >= 5).length;
            const outOfStockCount = products.filter(p => p.stock <= 0).length;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Normal Stock', 'Low Stock', 'Out of Stock'],
                    datasets: [{
                        data: [normalStockCount, lowStockCount, outOfStockCount],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function generateCustomerChart() {
            const ctx = document.getElementById('customer-chart');
            if (!ctx) return;
            
            const customersWithBalance = customers.filter(c => c.balanceDue > 0).length;
            const customersWithoutBalance = customers.filter(c => c.balanceDue <= 0).length;
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Customers with Balance', 'Customers without Balance'],
                    datasets: [{
                        data: [customersWithBalance, customersWithoutBalance],
                        backgroundColor: ['#3b82f6', '#6b7280'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Report generation handler
        function generateReport() {
            const reportType = document.getElementById('report-type').value;
            const reportPeriod = document.getElementById('report-period').value;
            
            // Hide all chart containers
            document.querySelectorAll('[id$="-chart-container"]').forEach(container => {
                container.classList.add('hidden');
            });
            
            // Hide default message
            document.getElementById('report-preview').classList.add('hidden');
            
            // Show appropriate chart
            switch(reportType) {
                case 'sales':
                    document.getElementById('sales-chart-container').classList.remove('hidden');
                    generateSalesChart();
                    break;
                case 'profit':
                    document.getElementById('profit-chart-container').classList.remove('hidden');
                    generateProfitChart();
                    break;
                case 'inventory':
                    document.getElementById('inventory-chart-container').classList.remove('hidden');
                    generateInventoryChart();
                    break;
                case 'customers':
                    document.getElementById('customer-chart-container').classList.remove('hidden');
                    generateCustomerChart();
                    break;
            }
        }

        function updateUIText() {
            const lang = uiText[currentLanguage];
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (lang[key]) {
                    el.textContent = lang[key];
                }
            });
            document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-key-placeholder');
                if (lang[key]) {
                    el.placeholder = lang[key];
                }
            });
            const placeholderUrl = `https://placehold.co/128x128/ffedd5/f97316?text=${lang.image_placeholder || 'Image'}`; 
            // REMOVED: Add product image preview update
            if (!editProductImagePreview.src.startsWith('http') || editProductImagePreview.src.includes('placehold.co')) {
                 editProductImagePreview.src = placeholderUrl;
            }
            loginError.textContent = lang.login_error;
            headerTitle.textContent = lang[`dashboard_title_${currentView}`] || lang.erp_title_short;

            updateEditProductLabels();

            const aiWelcomeBubble = chatLog.querySelector('.ai-bubble[data-lang-key="welcome_msg_listening"]');
            if(aiWelcomeBubble) {
                aiWelcomeBubble.textContent = lang.welcome_msg_listening;
            }
        }

        // REMOVED: updateAddProductLabels

        function updateEditProductLabels() {
            const lang = uiText[currentLanguage];
            const unit = editProductUnitInput.value;
            if (unit === 'kg') {
                editProductStockLabel.textContent = lang.form_stock_kg;
                editProductSellingPriceLabel.textContent = lang.form_selling_price_kg;
            } else {
                editProductStockLabel.textContent = lang.form_stock_piece;
                editProductSellingPriceLabel.textContent = lang.form_selling_price_piece;
            }
        }

        function switchView(viewId) {
            currentView = viewId;
            const lang = uiText[currentLanguage];
            
            headerTitle.textContent = lang[`dashboard_title_${viewId}`] || lang.erp_title_short;

            // --- !!! ---
            // UI-MOD: Updated logic to work with new CSS classes
            navLinks.forEach(link => {
                if (!link || !link.id) return; 
                if (link.id === `nav-${viewId}`) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
            // --- !!! ---
            
            navLinksMobile.forEach(link => {
                if (!link || !link.id) return;
                if (link.id === `nav-mobile-${viewId}`) {
                    link.classList.add('text-orange-600');
                    link.classList.remove('text-gray-500');
                } else {
                    link.classList.remove('text-orange-600');
                    link.classList.add('text-gray-500');
                }
            });

            dataViews.forEach(view => {
                 if (!view || !view.id) return; // Add null check
                if (view.id === `view-${viewId}`) {
                    view.classList.remove('hidden');
                } else {
                    view.classList.add('hidden');
                }
            });

            if (viewId === 'purchase') {
                populatePOProductSelect();
            }
            if (viewId === 'billing') {
                populateBillingDropdowns();
            }
            // REMOVED: Add Entry Logic
            if (viewId === 'dashboard') {
                updateDashboardAlerts();
                updateDashboardCards(); // Recalculate profits when viewing dashboard
            }
            if (viewId === 'assistant' && recognition && !isListening) {
                 try {
                     recognition.start();
                 } catch(e) {
                     console.error("Could not auto-start recognition:", e);
                 }
            } else if (viewId !== 'assistant' && recognition && isListening) {
                 recognition.stop();
            }
        }

        // REMOVED: switchManualTab

        function updateDashboardCards() {
            dashboardTotalCustomers.textContent = customers.length;
            dashboardTotalProducts.textContent = products.length;
            
            const totalBalance = customers.reduce((sum, c) => {
                const balance = c.balanceDue || 0;
                return balance > 0 ? sum + balance : sum; 
            }, 0);
            dashboardTotalBalance.textContent = `₹${totalBalance.toFixed(2)}`;
            
            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    
            const dailyProfit = transactions
                .filter(t => t.type === 'sale' && new Date(t.date) >= todayStart)
                .reduce((sum, t) => sum + (t.profit || 0), 0);
            
            const monthlyProfit = transactions
                .filter(t => t.type === 'sale' && new Date(t.date) >= monthStart)
                .reduce((sum, t) => sum + (t.profit || 0), 0);
    
            dashboardDailyProfit.textContent = `₹${dailyProfit.toFixed(2)}`;
            dashboardMonthlyProfit.textContent = `₹${monthlyProfit.toFixed(2)}`;
            
        }

        function updateDashboardAlerts() {
            const lang = uiText[currentLanguage];
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const thresholdDate = new Date(today.getTime() + (EXPIRY_DAYS_THRESHOLD + 1) * 24 * 60 * 60 * 1000);

            // Handle expiring products
            const expiringProducts = products.filter(p => {
                if (!p.expDate) return false;
                try {
                    const expDate = new Date(p.expDate);
                    expDate.setHours(0,0,0,0); 
                    return expDate < thresholdDate && expDate >= today;
                } catch(e) {
                    return false;
                }
            });

            expiryAlertList.innerHTML = '';
            if (expiringProducts.length === 0) {
                expiryAlertPlaceholder.classList.remove('hidden');
            } else {
                expiryAlertPlaceholder.classList.add('hidden');
                expiringProducts.forEach(product => {
                    const item = document.createElement('div');
                    item.className = "flex items-center justify-between p-3 bg-gradient-to-r from-red-50 to-red-100 rounded-lg border-l-4 border-red-500 shadow-sm hover:shadow-md transition-all duration-200";
                    
                    const leftSection = document.createElement('div');
                    leftSection.className = "flex items-center space-x-3";
                    
                    const icon = document.createElement('div');
                    icon.className = "w-8 h-8 bg-red-500 rounded-full flex items-center justify-center";
                    icon.innerHTML = '<i data-lucide="alert-triangle" class="w-4 h-4 text-white"></i>';
                    leftSection.appendChild(icon);
                    
                    const textSection = document.createElement('div');
                    const productName = document.createElement('p');
                    productName.className = "text-sm font-semibold text-red-800";
                    productName.textContent = product.name;
                    textSection.appendChild(productName);
                    
                    const expiryText = document.createElement('p');
                    expiryText.className = "text-xs text-red-600";
                    expiryText.textContent = `${lang.expires_on}: ${product.expDate}`;
                    textSection.appendChild(expiryText);
                    
                    leftSection.appendChild(textSection);
                    item.appendChild(leftSection);

                    const urgencyBadge = document.createElement('div');
                    urgencyBadge.className = "px-2 py-1 bg-red-500 text-white text-xs font-bold rounded-full";
                    urgencyBadge.textContent = "URGENT";
                    item.appendChild(urgencyBadge);

                    expiryAlertList.appendChild(item);
                });
            }

            // Handle low stock alerts - SIMPLIFIED VERSION
            const lowStockThreshold = parseInt(localStorage.getItem('lowStockThreshold')) || 5;
            const lowStockAlertList = document.getElementById('low-stock-alert-list');
            const lowStockAlertPlaceholder = document.getElementById('low-stock-alert-placeholder');
            
            // Clear previous alerts
            lowStockAlertList.innerHTML = '';
            
            // Find low stock products
            const lowStockProducts = products.filter(p => p.stock <= lowStockThreshold && p.stock > 0);
            const outOfStockProducts = products.filter(p => p.stock <= 0);
            
            if (lowStockProducts.length === 0 && outOfStockProducts.length === 0) {
                lowStockAlertPlaceholder.classList.remove('hidden');
            } else {
                lowStockAlertPlaceholder.classList.add('hidden');
                
                // Add out of stock products
                outOfStockProducts.forEach(product => {
                    const alertItem = document.createElement('div');
                    alertItem.className = "p-3 mb-2 bg-red-100 border border-red-300 rounded-lg";
                    alertItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="x-circle" class="w-4 h-4 text-red-600"></i>
                                <span class="font-semibold text-red-800">${product.name}</span>
                            </div>
                            <span class="text-sm text-red-600 font-bold">OUT OF STOCK</span>
                        </div>
                    `;
                    lowStockAlertList.appendChild(alertItem);
                });
                
                // Add low stock products
                lowStockProducts.forEach(product => {
                    const alertItem = document.createElement('div');
                    alertItem.className = "p-3 mb-2 bg-orange-100 border border-orange-300 rounded-lg";
                    alertItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="alert-triangle" class="w-4 h-4 text-orange-600"></i>
                                <span class="font-semibold text-orange-800">${product.name}</span>
                            </div>
                            <span class="text-sm text-orange-600 font-bold">${product.stock} ${product.unit}</span>
                        </div>
                    `;
                    lowStockAlertList.appendChild(alertItem);
                });
            }
            
            // Update icons after adding elements
            lucide.createIcons();
            
            // Update dashboard stats
            const outOfStockCount = document.getElementById('out-of-stock-count');
            const lowStockCount = document.getElementById('low-stock-count');
            const expiringCount = document.getElementById('expiring-count');
            
            if (outOfStockCount) outOfStockCount.textContent = outOfStockProducts.length;
            if (lowStockCount) lowStockCount.textContent = lowStockProducts.length;
            if (expiringCount) expiringCount.textContent = expiringProducts.length;
        }
        
        function addActivity(message, icon = 'check-circle') {
            const lang = uiText[currentLanguage];
            recentActivityPlaceholder.classList.add('hidden');
            
            const item = document.createElement('div');
            item.className = "flex items-center space-x-3";
            
            const iconEl = document.createElement('div');
            iconEl.className = "flex-shrink-0";
            iconEl.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 text-gray-400"></i>`; 
            
            const textEl = document.createElement('p');
            textEl.className = "text-sm text-gray-700";
            textEl.textContent = message;
            
            const timeEl = document.createElement('p');
            timeEl.className = "text-xs text-gray-400 ml-auto";
            timeEl.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            item.appendChild(iconEl);
            item.appendChild(textEl);
            item.appendChild(timeEl);
            
            recentActivityList.prepend(item);
            lucide.createIcons(); 
        }

        function renderCustomers() {
            customerList.innerHTML = ''; 
            const lang = uiText[currentLanguage];
            
            const searchText = customerSearchInput.value.toLowerCase();
            const filteredCustomers = customers.filter(c => c.name.toLowerCase().includes(searchText));
            
            filteredCustomers.sort((a, b) => a.name.localeCompare(b.name));

            const totalItems = filteredCustomers.length;
            const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
            if (customerCurrentPage > totalPages) customerCurrentPage = totalPages;
            
            const startIndex = (customerCurrentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = customerCurrentPage * ITEMS_PER_PAGE;
            const paginatedCustomers = filteredCustomers.slice(startIndex, endIndex);

            customerPageInfo.textContent = `Page ${customerCurrentPage} of ${totalPages}`;
            customerPrevBtn.disabled = customerCurrentPage === 1;
            customerNextBtn.disabled = customerCurrentPage === totalPages;
            
            if (paginatedCustomers.length === 0) {
                customerListPlaceholder.textContent = lang.no_customers;
                customerList.appendChild(customerListPlaceholder);
            } else {
                if (customerList.contains(customerListPlaceholder)) {
                    customerList.removeChild(customerListPlaceholder);
                }

                paginatedCustomers.forEach((customer) => {
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-xl shadow-lg p-4 border border-slate-200 relative";
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = "absolute top-3 right-3 text-gray-400 hover:text-red-500 transition-colors";
                    deleteBtn.innerHTML = `<i data-lucide="trash-2" class="w-5 h-5"></i>`;
                    deleteBtn.onclick = () => deleteCustomer(customer.name); 
                    card.appendChild(deleteBtn);

                    const name = document.createElement('h3');
                    name.className = "text-xl font-semibold text-orange-700";
                    name.textContent = customer.name;
                    card.appendChild(name);
                    
                    const balance = document.createElement('p');
                    balance.className = "text-lg mt-2";
                    const balanceAmount = customer.balanceDue || 0;
                    const balanceLabel = lang.form_balance.replace(' (₹)', '');
                    const creditLabel = lang.credit_balance || 'Credit';

                    if (balanceAmount > 0) {
                        balance.classList.add('text-red-600');
                        balance.textContent = `${balanceLabel}: ₹${balanceAmount.toFixed(2)}`;
                    } else if (balanceAmount < 0) {
                        balance.classList.add('text-green-600');
                        balance.textContent = `${creditLabel}: ₹${Math.abs(balanceAmount).toFixed(2)}`;
                    } else {
                        balance.classList.add('text-gray-600');
                        balance.textContent = `${balanceLabel}: ₹0.00`;
                    }
                    card.appendChild(balance);

                    if (customer.products && customer.products.length > 0) {
                        const productsTitle = document.createElement('p');
                        productsTitle.className = "text-sm font-medium text-gray-500 mt-3";
                        productsTitle.textContent = lang.product_list;
                        card.appendChild(productsTitle);

                        const productListEl = document.createElement('div');
                        productListEl.className = "flex flex-wrap gap-2 mt-1";
                        customer.products.forEach(product => {
                            const item = document.createElement('span');
                            item.className = "text-sm bg-slate-100 text-gray-700 px-2 py-1 rounded-full";
                            item.textContent = product;
                            productListEl.appendChild(item);
                        });
                        card.appendChild(productListEl);
                    }
                    
                    const payBtn = document.createElement('button');
                    // UI-MOD: Apply new button style
                    payBtn.className = "mt-4 w-full btn-primary py-2 px-4 text-sm";
                    payBtn.innerHTML = `<i data-lucide="indian-rupee" class="w-4 h-4 inline-block -mt-1 mr-1"></i> ${lang.record_payment || 'Record Payment'}`;
                    payBtn.onclick = () => openPaymentModal(customer.name, customer.balanceDue || 0);
                    card.appendChild(payBtn);

                    const date = document.createElement('p');
                    date.className = "text-xs text-gray-400 mt-3 text-right";
                    date.textContent = customer.createdAt.toLocaleString();
                    card.appendChild(date);
                    
                    customerList.appendChild(card);
                });
                lucide.createIcons();
            }
        }

        function renderProducts() {
            productList.innerHTML = ''; 
            const lang = uiText[currentLanguage];

            const searchText = productSearchInput.value.toLowerCase();
            const filteredProducts = products.filter(p => p.name.toLowerCase().includes(searchText));

            filteredProducts.sort((a, b) => a.name.localeCompare(b.name));

            const totalItems = filteredProducts.length;
            const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
            if (productCurrentPage > totalPages) productCurrentPage = totalPages;

            const startIndex = (productCurrentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = productCurrentPage * ITEMS_PER_PAGE;
            const paginatedProducts = filteredProducts.slice(startIndex, endIndex);

            productPageInfo.textContent = `Page ${productCurrentPage} of ${totalPages}`;
            productPrevBtn.disabled = productCurrentPage === 1;
            productNextBtn.disabled = productCurrentPage === totalPages;

            if (paginatedProducts.length === 0) {
                productListPlaceholder.textContent = lang.no_products;
                productList.appendChild(productListPlaceholder);
            } else {
                if (productList.contains(productListPlaceholder)) {
                    productList.removeChild(productListPlaceholder);
                }

                paginatedProducts.forEach((product) => {
                    const card = document.createElement('div');
                    card.className = "product-card bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden";
                    card.addEventListener('click', () => openEditProductModal(product));
                    
                    const img = document.createElement('img');
                    img.src = product.imageUrl;
                    img.alt = product.name;
                    img.className = "w-full h-40 object-contain bg-slate-50 p-2";
                    img.onerror = () => { img.src = `https://placehold.co/128x128/ffedd5/f97316?text=${lang.image_placeholder || 'Image'}`; }; 
                    card.appendChild(img);
                    
                    const content = document.createElement('div');
                    content.className = "p-4";
                    
                    const name = document.createElement('h3');
                    name.className = "text-lg font-semibold text-orange-700 truncate";
                    name.textContent = product.name;
                    content.appendChild(name);

                    const stock = document.createElement('p');
                    stock.className = "text-sm text-gray-700 mt-2 font-medium";
                    const stockUnit = product.unit === 'kg' ? 'kg' : (lang.unit_pcs || 'pcs');
                    stock.textContent = `${lang.stock}: ${product.stock} ${stockUnit}`;
                    content.appendChild(stock);

                    const cost = document.createElement('p');
                    cost.className = "text-sm text-gray-500 mt-1";
                    cost.textContent = `${lang.cost_price}: ₹${product.costPrice.toFixed(2)} / ${product.unit}`;
                    content.appendChild(cost);

                    const price = document.createElement('p');
                    price.className = "text-lg font-bold text-gray-900 mt-1";
                    price.textContent = `₹${product.sellingPrice.toFixed(2)} / ${product.unit}`;
                    content.appendChild(price);
                    
                    if (product.mfgDate) {
                        const mfg = document.createElement('p');
                        mfg.className = "text-xs text-gray-500 mt-2";
                        mfg.textContent = `${lang.form_mfg}: ${product.mfgDate}`;
                        content.appendChild(mfg);
                    }
                    if (product.expDate) {
                        const exp = document.createElement('p');
                        exp.className = "text-xs text-red-600 font-medium mt-1";
                        exp.textContent = `${lang.form_exp}: ${product.expDate}`;
                        content.appendChild(exp);
                    }

                    card.appendChild(content);
                    productList.appendChild(card);
                });
            }
        }
        
        function renderPurchaseOrders(poToRender = purchaseOrders) {
            poList.innerHTML = '';
            const lang = uiText[currentLanguage];

            if (poToRender.length === 0) {
                poListPlaceholder.textContent = lang.no_po;
                poList.appendChild(poListPlaceholder);
            } else {
                if (poList.contains(poListPlaceholder)) {
                    poList.removeChild(poListPlaceholder);
                }
                poToRender.forEach(po => {
                    const card = document.createElement('div');
                    card.className = "bg-slate-50 rounded-xl p-4 border border-slate-200";
                    
                    const header = document.createElement('div');
                    header.className = "flex justify-between items-center";
                    const supplier = document.createElement('h3');
                    supplier.className = "text-lg font-semibold text-orange-700";
                    supplier.textContent = po.supplier;
                    const date = document.createElement('p');
                    date.className = "text-sm text-gray-500";
                    date.textContent = po.date.toLocaleDateString();
                    header.appendChild(supplier);
                    header.appendChild(date);
                    card.appendChild(header);
                    
                    const total = document.createElement('p');
                    total.className = "text-xl font-bold text-gray-800 mt-1";
                    total.textContent = `Total: ₹${po.totalCost.toFixed(2)}`;
                    card.appendChild(total);
                    
                    const itemsTitle = document.createElement('p');
                    itemsTitle.className = "text-sm font-medium text-gray-500 mt-3";
                    itemsTitle.textContent = "Items:";
                    card.appendChild(itemsTitle);
                    
                    const itemsListEl = document.createElement('ul');
                    itemsListEl.className = "list-disc list-inside text-gray-700 mt-1 space-y-1";
                    po.items.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = `${item.name} (Qty: ${item.qty}, Cost: ₹${item.cost.toFixed(2)}/unit)`;
                        itemsListEl.appendChild(li);
                    });
                    card.appendChild(itemsListEl);
                    poList.appendChild(card);
                });
            }
        }
        
        function populatePOProductSelect() {
            poProductSelect.innerHTML = `<option value="">${uiText[currentLanguage].select_product}</option>`;
            products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.name;
                option.textContent = `${p.name} (${p.unit})`; 
                option.dataset.cost = p.costPrice;
                poProductSelect.appendChild(option);
            });
        }
        
        function renderPOItems() {
            poItemsList.innerHTML = '';
            currentPOItems.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = "flex justify-between items-center bg-slate-100 p-2 rounded-lg";
                itemEl.innerHTML = `
                    <p class="text-sm text-gray-800">${item.name} (Qty: ${item.qty})</p>
                    <p class="text-sm font-medium text-gray-800">₹${(item.qty * item.cost).toFixed(2)}</p>
                `;
                const removeBtn = document.createElement('button');
                removeBtn.className = "text-red-500 hover:text-red-700";
                removeBtn.innerHTML = `<i data-lucide="x-circle" class="w-4 h-4"></i>`;
                removeBtn.onclick = () => {
                    currentPOItems.splice(index, 1);
                    renderPOItems();
                    addActivity(uiText[currentLanguage].po_item_removed, 'x-circle');
                };
                itemEl.appendChild(removeBtn);
                poItemsList.appendChild(itemEl);
            });
            lucide.createIcons();
        }

        // --- Billing Functions ---
        function populateBillingDropdowns() {
            const lang = uiText[currentLanguage];
            
            customerDatalist.innerHTML = '';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.name;
                customerDatalist.appendChild(option);
            });

            billingProductSelect.innerHTML = `<option value="">${lang.select_product}</option>`;
            products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.name;
                option.textContent = `${p.name} (₹${p.sellingPrice.toFixed(2)} / ${p.unit})`;
                option.dataset.price = p.sellingPrice;
                option.dataset.cost = p.costPrice;
                option.dataset.stock = p.stock;
                option.dataset.unit = p.unit; 
                billingProductSelect.appendChild(option);
            });

            updateBillingUnitSelect();
        }

        function updateBillingUnitSelect() {
            const lang = uiText[currentLanguage];
            const selectedOption = billingProductSelect.options[billingProductSelect.selectedIndex];
            const productUnit = selectedOption.dataset.unit;

            if (productUnit === 'kg') {
                billingUnitSelect.innerHTML = `
                    <option value="g">${lang.unit_g || 'g'}</option>
                    <option value="kg">${lang.unit_kg || 'kg'}</option>
                `;
                billingUnitSelect.classList.remove('hidden');
                billingUnitSelect.previousElementSibling.classList.remove('hidden'); 
            } else if (productUnit === 'piece') {
                billingUnitSelect.innerHTML = `<option value="pcs">${lang.unit_pcs || 'pcs'}</option>`;
                billingUnitSelect.classList.remove('hidden');
                billingUnitSelect.previousElementSibling.classList.remove('hidden'); 
            } else {
                billingUnitSelect.innerHTML = '';
                billingUnitSelect.classList.add('hidden');
                billingUnitSelect.previousElementSibling.classList.add('hidden'); 
            }
        }


        function renderBillItems() {
            const lang = uiText[currentLanguage];
            billingItemsList.innerHTML = '';
            let currentTotal = 0;

            if (currentBillItems.length === 0) {
                billingItemsPlaceholder.classList.remove('hidden');
            } else {
                billingItemsPlaceholder.classList.add('hidden');
                currentBillItems.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = "flex justify-between items-center bg-slate-100 p-2 rounded-lg";
                    
                    const details = document.createElement('p');
                    details.className = "text-sm text-gray-800";
                    details.innerHTML = `${item.name} <span class="text-xs text-gray-500">(${item.displayQty})</span>`;
                    
                    const total = document.createElement('p');
                    total.className = "text-sm font-medium text-gray-800";
                    total.textContent = `₹${item.lineTotal.toFixed(2)}`;

                    const removeBtn = document.createElement('button');
                    removeBtn.className = "text-red-500 hover:text-red-700 ml-2";
                    removeBtn.innerHTML = `<i data-lucide="x-circle" class="w-4 h-4"></i>`;
                    removeBtn.onclick = () => {
                        currentBillItems.splice(index, 1);
                        renderBillItems();
                    };

                    itemEl.appendChild(details);
                    const rightDiv = document.createElement('div');
                    rightDiv.className = "flex items-center";
                    rightDiv.appendChild(total);
                    rightDiv.appendChild(removeBtn);
                    itemEl.appendChild(rightDiv);

                    billingItemsList.appendChild(itemEl);
                    currentTotal += item.lineTotal;
                });
            }
            billingTotal.textContent = `₹${currentTotal.toFixed(2)}`;
            
            // Debug: Log the total
            console.log('Billing total updated:', currentTotal, 'Items:', currentBillItems.length);
            
            lucide.createIcons();
        }

        function handleAddToBill() {
            const lang = uiText[currentLanguage];
            const productName = billingProductSelect.value;
            const selectedOption = billingProductSelect.options[billingProductSelect.selectedIndex];
            
            if (!productName || !selectedOption.dataset.price) {
                addActivity(lang.select_product, 'alert-circle');
                return;
            }

            const unitPrice = parseFloat(selectedOption.dataset.price);
            const costPrice = parseFloat(selectedOption.dataset.cost) || 0;
            const productUnit = selectedOption.dataset.unit;
            const stock = parseFloat(selectedOption.dataset.stock);
            const billingQty = parseFloat(billingQtyInput.value);
            const billingUnit = billingUnitSelect.value;

            if (!billingQty || billingQty <= 0) {
                addActivity("Please enter a valid quantity.", 'alert-circle');
                return;
            }

            let lineItemTotalPrice = 0;
            let stockToDeduct = 0;
            let lineItemCost = 0;
            let displayQtyString = `${billingQty} ${billingUnit}`;

            if (productUnit === 'piece') {
                if (billingUnit !== 'pcs') { /* Safety check */ }
                lineItemTotalPrice = billingQty * unitPrice;
                lineItemCost = billingQty * costPrice;
                stockToDeduct = billingQty;
            } else if (productUnit === 'kg') {
                if (billingUnit === 'g') {
                    stockToDeduct = billingQty / 1000;
                } else { // billingUnit is 'kg'
                    stockToDeduct = billingQty;
                }
                lineItemTotalPrice = stockToDeduct * unitPrice;
                lineItemCost = stockToDeduct * costPrice;
            }

            if (stockToDeduct > stock) {
                addActivity(`${lang.billing_error_stock} ${productName}. Only ${stock} ${productUnit} available.`, 'alert-circle');
                return;
            }

            const existingItemIndex = currentBillItems.findIndex(item => item.name === productName && item.displayQty.endsWith(billingUnit));
            if (existingItemIndex > -1) {
                currentBillItems[existingItemIndex].stockToDeduct += stockToDeduct;
                currentBillItems[existingItemIndex].lineTotal += lineItemTotalPrice;
                currentBillItems[existingItemIndex].lineCost += lineItemCost;
                const oldQty = parseFloat(currentBillItems[existingItemIndex].displayQty);
                const newQty = oldQty + billingQty;
                currentBillItems[existingItemIndex].displayQty = `${newQty} ${billingUnit}`;
            } else {
                currentBillItems.push({ 
                    name: productName, 
                    displayQty: displayQtyString, 
                    lineTotal: lineItemTotalPrice, 
                    lineCost: lineItemCost,
                    stockToDeduct: stockToDeduct, 
                    productUnit: productUnit 
                });
            }
            
            renderBillItems();

            billingProductSelect.value = "";
            billingQtyInput.value = "1";
            updateBillingUnitSelect(); 
        }

        function handleFinalizeBill() {
            const lang = uiText[currentLanguage];
            const customerName = billingCustomerSearch.value.trim();
            
            if (!customerName) {
                addActivity(lang.billing_error_customer, 'alert-circle');
                billingStatus.textContent = lang.billing_error_customer;
                return;
            }
            if (currentBillItems.length === 0) {
                addActivity(lang.billing_error_no_items, 'alert-circle');
                billingStatus.textContent = lang.billing_error_no_items;
                return;
            }

            let billTotal = 0;
            let billCost = 0;

            currentBillItems.forEach(item => {
                const productIndex = products.findIndex(p => p.name === item.name);
                if (productIndex > -1) {
                    products[productIndex].stock -= item.stockToDeduct;
                    billTotal += item.lineTotal;
                    billCost += (item.lineCost || 0);
                }
            });

            // Get payment method
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;

            let customerIndex = customers.findIndex(c => c.name.toLowerCase() === customerName.toLowerCase());
            if (customerIndex > -1) {
                // Only add to balance if payment method is "due"
                if (paymentMethod === 'due') {
                customers[customerIndex].balanceDue = (customers[customerIndex].balanceDue || 0) + billTotal;
                }
            } else {
                // Create new customer with balance only if payment method is "due"
                const initialBalance = paymentMethod === 'due' ? billTotal : 0;
                addCustomerToList({
                    name: customerName,
                    balanceDue: initialBalance,
                    products: currentBillItems.map(item => item.name) 
                });
                addActivity(`New customer "${customerName}" added.`, 'user-plus');
                customerIndex = customers.findIndex(c => c.name.toLowerCase() === customerName.toLowerCase()); 
            }
            if (customerIndex > -1) {
                 const currentBillProductNames = currentBillItems.map(item => item.name);
                 customers[customerIndex].products = customers[customerIndex].products || [];
                 currentBillProductNames.forEach(newItem => {
                      if (!customers[customerIndex].products.includes(newItem)) {
                           customers[customerIndex].products.push(newItem);
                      }
                 });
            }

            const billProfit = billTotal - billCost;
            addActivity(`New bill for ${customerName} (Total: ₹${billTotal.toFixed(2)})`, 'receipt');
            transactions.push({ type: 'sale', date: new Date(), total: billTotal, cost: billCost, profit: billProfit, customer: customerName, items: [...currentBillItems] });
            
            billingStatus.textContent = lang.billing_success;
            setTimeout(() => { billingStatus.textContent = ''; }, 3000);

            currentBillItems = [];
            renderBillItems();
            billingCustomerSearch.value = ""; 
            billingCustomerName.textContent = "None"; 
            updateBillingUnitSelect(); 

            renderCustomers();
            renderProducts();
            updateDashboardCards();
            updateDashboardAlerts();
        }
        // --- End Billing Functions ---

        // --- Search Handlers ---
        function handleCustomerSearch() {
            customerCurrentPage = 1; 
            renderCustomers();
        }
        
        function handleProductSearch() {
            productCurrentPage = 1; 
            renderProducts();
        }

        // --- Payment Modal Functions ---
        function openPaymentModal(name, balance) {
            paymentModal.dataset.customerName = name;
            modalCustomerName.textContent = name;
            
            const balanceAmount = balance || 0;
            if (balanceAmount < 0) {
                modalCurrentBalance.textContent = `₹${Math.abs(balanceAmount).toFixed(2)} (${uiText[currentLanguage].credit_balance || 'Credit'})`;
            } else {
                modalCurrentBalance.textContent = `₹${balanceAmount.toFixed(2)}`;
            }

            modalPaymentAmount.value = '';
            paymentModal.classList.remove('hidden');
            modalPaymentAmount.focus();
        }

        function closePaymentModal() {
            paymentModal.classList.add('hidden');
        }

        function savePaymentFromModal() {
            const name = paymentModal.dataset.customerName;
            const amount = parseFloat(modalPaymentAmount.value) || 0;
            if (amount > 0) {
                payBalance(name, amount);
            }
            closePaymentModal();
        }

        // --- Edit Product Modal Functions ---
        function openEditProductModal(product) {
            editProductModal.dataset.originalName = product.name;
            editProductNameInput.value = product.name;
            editProductImagePreview.src = product.imageUrl || `https://placehold.co/128x128/ffedd5/f97316?text=${product.name}`; 
            editProductUnitInput.value = product.unit;
            editProductStockInput.value = product.stock;
            editProductCostPriceInput.value = product.costPrice;
            editProductSellingPriceInput.value = product.sellingPrice;
            editProductMfgInput.value = product.mfgDate || '';
            editProductExpInput.value = product.expDate || '';
            updateEditProductLabels(); 
            editProductModal.classList.remove('hidden');
        }

        function closeEditProductModal() {
            editProductModal.classList.add('hidden');
            editProductModal.dataset.originalName = '';
        }

        function saveProductChanges() {
            const originalName = editProductModal.dataset.originalName;
            const productIndex = products.findIndex(p => p.name === originalName);

            if (productIndex === -1) {
                console.error("Could not find product to edit:", originalName);
                closeEditProductModal();
                return;
            }

            products[productIndex].name = editProductNameInput.value.trim();
            products[productIndex].imageUrl = editProductImagePreview.src;
            products[productIndex].unit = editProductUnitInput.value;
            products[productIndex].stock = parseFloat(editProductStockInput.value) || 0;
            products[productIndex].costPrice = parseFloat(editProductCostPriceInput.value) || 0;
            products[productIndex].sellingPrice = parseFloat(editProductSellingPriceInput.value) || 0;
            products[productIndex].mfgDate = editProductMfgInput.value || null;
            products[productIndex].expDate = editProductExpInput.value || null;

            renderProducts();
            updateDashboardCards();
            updateDashboardAlerts();
            addActivity(`Product "${products[productIndex].name}" updated.`, 'edit');

            closeEditProductModal();
        }

        // --- PDF Download Functions ---
        function downloadCustomersPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const lang = uiText[currentLanguage];
            
            const searchText = customerSearchInput.value.toLowerCase();
            const filteredCustomers = customers.filter(c => c.name.toLowerCase().includes(searchText));
            filteredCustomers.sort((a, b) => a.name.localeCompare(b.name));
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.text(lang.nav_customers || "Customers", 14, 22);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.setTextColor(100);
            
            let y = 40;
            const headers = ["Name", "Balance/Credit (INR)", "Products"];
            doc.setFont('helvetica', 'bold');
            doc.text(headers[0], 14, y);
            doc.text(headers[1], 70, y);
            doc.text(headers[2], 120, y);
            y += 7;
            doc.setLineWidth(0.5);
            doc.line(14, y, 196, y);
            y += 10;
            doc.setFont('helvetica', 'normal');

            filteredCustomers.forEach(customer => {
                if (y > 280) { 
                    doc.addPage();
                    y = 20;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.text(headers[0], 14, y);
                    doc.text(headers[1], 70, y);
                    doc.text(headers[2], 120, y);
                    y += 7;
                    doc.setLineWidth(0.5);
                    doc.line(14, y, 196, y);
                    y += 10;
                    doc.setFont('helvetica', 'normal');
                }

                doc.setFontSize(10);
                let balanceText = "";
                const balance = customer.balanceDue || 0;
                if (balance > 0) {
                    balanceText = `Due: ${balance.toFixed(2)}`;
                } else if (balance < 0) {
                    balanceText = `Credit: ${Math.abs(balance).toFixed(2)}`;
                } else {
                    balanceText = "0.00";
                }
                
                const productsText = (customer.products || []).join(", ");
                const splitName = doc.splitTextToSize(customer.name, 50); 
                const splitProducts = doc.splitTextToSize(productsText, 70); 
                
                const nameLines = splitName.length;
                const productLines = splitProducts.length;
                const maxLines = Math.max(nameLines, productLines, 1);
                
                doc.text(splitName, 14, y);
                doc.text(balanceText, 70, y);
                doc.text(splitProducts, 120, y);
                
                y += (maxLines * 5) + 5; 
            });
            
            doc.save("customers.pdf");
        }

        function downloadProductsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const lang = uiText[currentLanguage];
            
            const searchText = productSearchInput.value.toLowerCase();
            const filteredProducts = products.filter(p => p.name.toLowerCase().includes(searchText));
            filteredProducts.sort((a, b) => a.name.localeCompare(b.name));

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.text(lang.nav_products || "Products", 14, 22);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.setTextColor(100);
            
            let y = 40;
            const headers = ["Name", "Stock", "Unit", "MFG", "EXP", "Price (INR)"];
            doc.setFont('helvetica', 'bold');
            doc.text(headers[0], 14, y);  
            doc.text(headers[1], 70, y);  
            doc.text(headers[2], 90, y);  
            doc.text(headers[3], 110, y); 
            doc.text(headers[4], 140, y); 
            doc.text(headers[5], 170, y); 
            y += 7;
            doc.setLineWidth(0.5);
            doc.line(14, y, 196, y);
            y += 10;
            doc.setFont('helvetica', 'normal');

            filteredProducts.forEach(product => {
                 if (y > 280) { 
                    doc.addPage();
                    y = 20;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.text(headers[0], 14, y);
                    doc.text(headers[1], 70, y);
                    doc.text(headers[2], 90, y);
                    doc.text(headers[3], 110, y);
                    doc.text(headers[4], 140, y);
                    doc.text(headers[5], 170, y);
                    y += 7;
                    doc.setLineWidth(0.5);
                    doc.line(14, y, 196, y);
                    y += 10;
                    doc.setFont('helvetica', 'normal');
                }

                doc.setFontSize(10);
                const splitName = doc.splitTextToSize(product.name, 50); 
                doc.text(splitName, 14, y);
                doc.text(product.stock.toString(), 70, y);
                doc.text(product.unit, 90, y);
                doc.text(product.mfgDate || 'N/A', 110, y);
                doc.text(product.expDate || 'N/A', 140, y);
                doc.text(product.sellingPrice.toFixed(2), 170, y);
                
                y += (splitName.length * 5) + 5;
            });

            doc.save("products.pdf");
        }

        // --- Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isListening = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = currentLanguage;
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true;
                status.textContent = uiText[currentLanguage].status_listening;
                micBtn.classList.add('listening', 'bg-red-700');
            };

            recognition.onend = () => {
                isListening = false;
                if (!loadingIndicator.classList.contains('hidden')) {
                    // Keep processing status if loading indicator is shown
                } else {
                     status.textContent = uiText[currentLanguage].status_ready;
                }
                micBtn.classList.remove('listening', 'bg-red-700');
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                if (event.error !== 'no-speech' || !loadingIndicator.classList.contains('hidden')) {
                    status.textContent = `${uiText[currentLanguage].status_error} ${event.error}.`;
                }
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim();
                addMessageToChat('user', transcript);
                handleAutoQuery(transcript);
            };

        } else {
            status.textContent = "Speech recognition not supported.";
            micBtn.disabled = true;
            micBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // --- Speech Synthesis ---
        const synthesis = window.speechSynthesis;

        function speak(text) {
            if (synthesis.speaking) {
                synthesis.cancel();
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = currentLanguage;
            utterance.onerror = (event) => {
                console.error("Speech synthesis error:", event.error);
            };
            synthesis.speak(utterance);
        }

        // --- Event Listeners ---

        loginBtn.addEventListener('click', async () => {
            const email = usernameInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                loginError.classList.remove('hidden');
                return;
            }
            
            try {
                loginBtn.disabled = true;
                loginBtn.textContent = 'Logging in...';
                
                const response = await loginSeller(email, password);
                
                if (response.success) {
                    loginScreen.classList.add('hidden');
                    erpApp.classList.remove('hidden');
                    erpApp.classList.add('flex'); 
                    displayUsername.textContent = currentUser.name || email; 
                    loginError.classList.add('hidden');
                    
                    // Set dashboard as active on login
                    switchView('dashboard');
                } else {
                    loginError.classList.remove('hidden');
                    loginError.textContent = response.message || 'Login failed';
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.classList.remove('hidden');
                loginError.textContent = 'Connection error. Please try again.';
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        });

        // Signup Form Validation
        function validateSignupForm() {
            const name = signupNameInput.value.trim();
            const email = signupEmailInput.value.trim();
            const mobile = signupMobileInput.value.trim();
            const password = signupPasswordInput.value;
            const confirmPassword = signupConfirmPasswordInput.value;

            // Clear previous errors
            signupError.classList.add('hidden');

            if (!name) {
                showSignupError('Please enter your full name');
                return false;
            }

            if (!email) {
                showSignupError('Please enter your email address');
                return false;
            }

            // Check email domain
            const emailDomain = email.split('@')[1];
            if (!emailDomain || (emailDomain !== 'gmail.com' && emailDomain !== 'email.com')) {
                showSignupError('Only Gmail and Email.com addresses are allowed');
                return false;
            }

            if (!mobile) {
                showSignupError('Please enter your mobile number');
                return false;
            }

            if (mobile.length !== 10 || !/^\d+$/.test(mobile)) {
                showSignupError('Please enter a valid 10-digit mobile number');
                return false;
            }

            if (!password) {
                showSignupError('Please enter a password');
                return false;
            }

            if (password.length < 6) {
                showSignupError('Password must be at least 6 characters long');
                return false;
            }

            if (password !== confirmPassword) {
                showSignupError('Passwords do not match');
                return false;
            }

            return true;
        }

        function showSignupError(message) {
            signupError.textContent = message;
            signupError.classList.remove('hidden');
        }

        function showOtpError(message) {
            otpError.textContent = message;
            otpError.classList.remove('hidden');
        }

        function switchToOtpForm(email) {
            signupForm.classList.add('hidden');
            otpForm.classList.remove('hidden');
            otpEmailSpan.textContent = email;
            otpInput.focus();
        }

        function switchToSignupForm() {
            otpForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            signupError.classList.add('hidden');
            otpError.classList.add('hidden');
        }

        function switchToLoginForm() {
            signupScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            signupError.classList.add('hidden');
            otpError.classList.add('hidden');
            // Clear signup form
            signupNameInput.value = '';
            signupEmailInput.value = '';
            signupMobileInput.value = '';
            signupPasswordInput.value = '';
            signupConfirmPasswordInput.value = '';
        }

        function switchToSignupScreen() {
            loginScreen.classList.add('hidden');
            signupScreen.classList.remove('hidden');
            loginError.classList.add('hidden');
            signupError.classList.add('hidden');
            otpError.classList.add('hidden');
            // Clear login form
            usernameInput.value = '';
            passwordInput.value = '';
        }

        // Signup Form Event Listeners
        signupBtn.addEventListener('click', async () => {
            if (!validateSignupForm()) {
                return;
            }

            const sellerData = {
                name: signupNameInput.value.trim(),
                email: signupEmailInput.value.trim(),
                mobileNumber: signupMobileInput.value.trim(),
                password: signupPasswordInput.value
            };

            try {
                signupBtn.disabled = true;
                signupBtn.textContent = 'Creating Account...';
                signupError.classList.add('hidden');

                const response = await registerSeller(sellerData);

                if (response.success) {
                    switchToOtpForm(sellerData.email);
                    showNotification('Verification code sent to your email!', 'success');
                } else {
                    showSignupError(response.message || 'Registration failed. Please try again.');
                }
            } catch (error) {
                console.error('Signup error:', error);
                showSignupError('Connection error. Please try again.');
            } finally {
                signupBtn.disabled = false;
                signupBtn.textContent = 'Create Account';
            }
        });

        // OTP Verification Event Listeners
        verifyOtpBtn.addEventListener('click', async () => {
            const otp = otpInput.value.trim();
            
            if (!otp) {
                showOtpError('Please enter the verification code');
                return;
            }

            if (otp.length !== 4 || !/^\d+$/.test(otp)) {
                showOtpError('Please enter a valid 4-digit code');
                return;
            }

            try {
                verifyOtpBtn.disabled = true;
                verifyOtpBtn.textContent = 'Verifying...';
                otpError.classList.add('hidden');

                const response = await verifyOtpAndRegister(otp);

                if (response.success) {
                    signupScreen.classList.add('hidden');
                    erpApp.classList.remove('hidden');
                    erpApp.classList.add('flex');
                    displayUsername.textContent = currentUser.name || signupEmailInput.value;
                    
                    showNotification('Account created successfully! Welcome!', 'success');
                    
                    // Set dashboard as active
                    switchView('dashboard');
                } else {
                    showOtpError(response.message || 'Invalid verification code');
                }
            } catch (error) {
                console.error('OTP verification error:', error);
                showOtpError('Verification failed. Please try again.');
            } finally {
                verifyOtpBtn.disabled = false;
                verifyOtpBtn.textContent = 'Verify & Complete Registration';
            }
        });

        // Navigation Event Listeners
        showSignupBtn.addEventListener('click', switchToSignupScreen);
        showLoginBtn.addEventListener('click', switchToLoginForm);
        backToSignupBtn.addEventListener('click', switchToSignupForm);

        // Resend OTP (for testing - always shows 1234)
        resendOtpBtn.addEventListener('click', () => {
            showNotification('OTP is always "1234" for testing. Use this code to verify.', 'info');
        });

        // Mobile number input formatting
        signupMobileInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
        });

        // OTP input formatting
        otpInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
        });
        
        navLinks.forEach(link => {
            link?.addEventListener('click', (e) => { 
                e.preventDefault();
                const view = link.id.split('-')[1]; 
                switchView(view);
            });
        });
        
        navLinksMobile.forEach(link => {
             link?.addEventListener('click', (e) => { 
                e.preventDefault();
                const view = link.id.split('-')[2]; 
                switchView(view);
            });
        });

        langToggle.addEventListener('change', () => {
            langToggleMobile.checked = langToggle.checked; 
            handleLangChange();
        });
        
        // Voice Assistant Language Toggle
        const langToggleAssistant = document.getElementById('lang-toggle-assistant');
        let voiceAssistantLanguage = 'en-US'; // Separate language state for voice assistant
        
        if (langToggleAssistant) {
            langToggleAssistant.addEventListener('change', () => {
                voiceAssistantLanguage = langToggleAssistant.checked ? 'hi-IN' : 'en-US';
                // Update voice assistant language without affecting main website
                updateVoiceAssistantLanguage();
            });
        }
        
        function updateVoiceAssistantLanguage() {
            // Update voice recognition language
            if (typeof recognition !== 'undefined') {
                recognition.lang = voiceAssistantLanguage;
            }
            
            // Update speech synthesis language
            if (typeof synthesis !== 'undefined') {
                const voices = synthesis.getVoices();
                const voice = voices.find(v => v.lang.startsWith(voiceAssistantLanguage.split('-')[0]));
                if (voice) {
                    synthesis.voice = voice;
                }
            }
        }

        function handleLangChange() {
             if (langToggle.checked) { 
                currentLanguage = 'hi-IN';
                langHiLabel.classList.add('text-gray-900');
                langEnLabel.classList.remove('text-gray-900');
                langEnLabel.classList.add('text-gray-400');
            } else { 
                currentLanguage = 'en-US';
                langEnLabel.classList.add('text-gray-900');
                langHiLabel.classList.remove('text-gray-900');
                langHiLabel.classList.add('text-gray-400');
            }
            if (recognition) {
                recognition.lang = currentLanguage;
            }
            updateUIText();
            renderCustomers(); 
            renderProducts(); 
            renderPurchaseOrders(); 
            updateDashboardAlerts(); 
        }

        micBtn.addEventListener('click', () => {
            if (!SpeechRecognition) return;
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch(e) {
                    console.error("Error starting recognition:", e);
                     if (e.name !== 'InvalidStateError') {
                         status.textContent = `${uiText[currentLanguage].status_error} Could not start listener.`;
                     }
                }
            }
        });

        sendBtn.addEventListener('click', () => {
            const query = textInput.value.trim();
            if (query) {
                addMessageToChat('user', query);
                handleAutoQuery(query);
                textInput.value = '';
            }
        });

        textInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendBtn.click();
            }
        });
        
        customerSearchInput.addEventListener('input', handleCustomerSearch);
        productSearchInput.addEventListener('input', handleProductSearch);

        // REMOVED: Add Entry listeners

        poProductSelect.addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const cost = selectedOption.dataset.cost;
            if (cost) {
                poCost.value = cost;
            }
        });
        
        addPOItemBtn.addEventListener('click', () => {
            const lang = uiText[currentLanguage];
            const productName = poProductSelect.value;
            const qty = parseFloat(poQty.value); 
            const cost = parseFloat(poCost.value);
            
            if (!productName || !qty || !cost) {
                addActivity("Please fill all PO item fields", 'alert-circle');
                return;
            }
            
            currentPOItems.push({ name: productName, qty, cost });
            renderPOItems();
            addActivity(lang.po_item_added, 'plus-circle');
            
            poProductSelect.value = "";
            poQty.value = "";
            poCost.value = "";
        });
        
        savePOBtn.addEventListener('click', () => {
            const lang = uiText[currentLanguage];
            const supplier = poSupplier.value;
            if (!supplier || currentPOItems.length === 0) {
                addActivity("Supplier and at least one item are required.", 'alert-circle');
                return;
            }
            
            const totalCost = currentPOItems.reduce((sum, item) => sum + (item.qty * item.cost), 0);
            
            const newPO = {
                id: `PO-${Date.now()}`,
                supplier,
                items: [...currentPOItems],
                totalCost,
                date: new Date()
            };
            
            purchaseOrders.unshift(newPO);
            
            transactions.push({ type: 'purchase', date: new Date(), total: totalCost, supplier: supplier, items: [...currentPOItems] });

            currentPOItems.forEach(item => {
                const productIndex = products.findIndex(p => p.name.toLowerCase() === item.name.toLowerCase());
                if (productIndex > -1) {
                    products[productIndex].stock = (products[productIndex].stock || 0) + item.qty;
                    addActivity(`${lang.stock_updated} ${item.name}`, 'package');
                }
            });
            
            renderPurchaseOrders(purchaseOrders);
            renderProducts(); 
            updateDashboardCards(); 
            updateDashboardAlerts(); 
            
            addActivity(`${lang.po_saved}: ${supplier}`, 'check-circle');
            
            poSupplier.value = "";
            currentPOItems = [];
            renderPOItems();
        });

        // Billing Listeners
        billingCustomerSearch.addEventListener('input', () => {
            const name = billingCustomerSearch.value;
            billingCustomerName.textContent = name || 'None';
        });
        billingProductSelect.addEventListener('change', updateBillingUnitSelect);
        addToBillBtn.addEventListener('click', handleAddToBill);
        finalizeBillBtn.addEventListener('click', handleFinalizeBill);

        // Add Customer and Product Event Listeners
        addCustomerBtn.addEventListener('click', () => {
            addCustomerModal.classList.remove('hidden');
            newCustomerNameInput.focus();
        });
        
        addProductBtn.addEventListener('click', () => {
            addProductModal.classList.remove('hidden');
            newProductNameInput.focus();
        });
        
        cancelAddCustomerBtn.addEventListener('click', () => {
            addCustomerModal.classList.add('hidden');
            // Clear form
            newCustomerNameInput.value = '';
            newCustomerPhoneInput.value = '';
            newCustomerEmailInput.value = '';
            newCustomerAddressInput.value = '';
        });
        
        cancelAddProductBtn.addEventListener('click', () => {
            addProductModal.classList.add('hidden');
            // Clear form
            newProductNameInput.value = '';
            newProductUnitInput.value = 'piece';
            newProductStockInput.value = '';
            newProductCostPriceInput.value = '';
            newProductSellingPriceInput.value = '';
            newProductMfgInput.value = '';
            newProductExpInput.value = '';
        });
        
        saveAddCustomerBtn.addEventListener('click', () => {
            const name = newCustomerNameInput.value.trim();
            const phone = newCustomerPhoneInput.value.trim();
            const email = newCustomerEmailInput.value.trim();
            const address = newCustomerAddressInput.value.trim();
            
            if (!name) {
                alert('Please enter customer name');
                return;
            }
            
            const customerData = {
                name: name,
                phone: phone || null,
                email: email || null,
                address: address || null,
                balanceDue: 0,
                products: []
            };
            
            addCustomerToList(customerData);
            addCustomerModal.classList.add('hidden');
            
            // Clear form
            newCustomerNameInput.value = '';
            newCustomerPhoneInput.value = '';
            newCustomerEmailInput.value = '';
            newCustomerAddressInput.value = '';
        });
        
        saveAddProductBtn.addEventListener('click', () => {
            const name = newProductNameInput.value.trim();
            const barcode = document.getElementById('new-product-barcode').value.trim();
            const unit = newProductUnitInput.value;
            const stock = parseFloat(newProductStockInput.value) || 0;
            const costPrice = parseFloat(newProductCostPriceInput.value) || 0;
            const sellingPrice = parseFloat(newProductSellingPriceInput.value) || 0;
            const mfgDate = newProductMfgInput.value || null;
            const expDate = newProductExpInput.value || null;
            
            if (!name) {
                alert('Please enter product name');
                return;
            }
            
            const productData = {
                name: name,
                barcode: barcode || null,
                unit: unit,
                stock: stock,
                costPrice: costPrice,
                sellingPrice: sellingPrice,
                mfgDate: mfgDate,
                expDate: expDate,
                imageUrl: `https://placehold.co/128x128/ffedd5/f97316?text=${name}`
            };
            
            addProductToList(productData);
            addProductModal.classList.add('hidden');
            
            // Clear form
            newProductNameInput.value = '';
            document.getElementById('new-product-barcode').value = '';
            newProductUnitInput.value = 'piece';
            newProductStockInput.value = '';
            newProductCostPriceInput.value = '';
            newProductSellingPriceInput.value = '';
            newProductMfgInput.value = '';
            newProductExpInput.value = '';
        });

        // Add Product Scanner functionality
        const addProductScannerBtn = document.getElementById('add-product-scanner-btn');
        if (addProductScannerBtn) {
            addProductScannerBtn.addEventListener('click', () => {
                // Check if camera is available
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    // Create scanner modal
                    const scannerModal = document.createElement('div');
                    scannerModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    scannerModal.innerHTML = `
                        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Scan Product Barcode</h3>
                                <button id="close-add-product-scanner" class="text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="text-center">
                                <div id="add-product-scanner-video" class="w-full h-64 bg-gray-100 rounded-lg mb-4 flex items-center justify-center">
                                    <div class="text-gray-500">
                                        <i data-lucide="camera" class="w-12 h-12 mx-auto mb-2"></i>
                                        <p>Camera access required for scanning</p>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <button id="start-add-product-scanner" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition-colors">
                                        Start Camera
                                    </button>
                                    <div class="text-sm text-gray-600">
                                        <p>Or enter barcode manually:</p>
                                        <input type="text" id="manual-add-product-barcode" placeholder="Enter barcode number" class="w-full mt-2 border border-gray-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <button id="search-add-product-barcode" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors">
                                            Use This Barcode
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(scannerModal);
                    lucide.createIcons();
                    
                    // Close scanner modal
                    document.getElementById('close-add-product-scanner').addEventListener('click', () => {
                        scannerModal.remove();
                    });
                    
                    // Start camera
                    document.getElementById('start-add-product-scanner').addEventListener('click', () => {
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(stream => {
                                const video = document.createElement('video');
                                video.srcObject = stream;
                                video.play();
                                video.className = 'w-full h-64 object-cover rounded-lg';
                                document.getElementById('add-product-scanner-video').innerHTML = '';
                                document.getElementById('add-product-scanner-video').appendChild(video);
                                
                                // Simulate barcode detection (in real app, use a barcode library)
                                setTimeout(() => {
                                    const mockBarcode = 'NEW' + Math.random().toString(36).substr(2, 9);
                                    document.getElementById('new-product-barcode').value = mockBarcode;
                                    scannerModal.remove();
                                }, 3000);
                            })
                            .catch(err => {
                                alert('Camera access denied. Please use manual entry.');
                            });
                    });
                    
                    // Manual barcode entry
                    document.getElementById('search-add-product-barcode').addEventListener('click', () => {
                        const barcode = document.getElementById('manual-add-product-barcode').value.trim();
                        if (barcode) {
                            document.getElementById('new-product-barcode').value = barcode;
                            scannerModal.remove();
                        } else {
                            alert('Please enter a barcode number');
                        }
                    });
                } else {
                    alert('Camera not available. Please use manual entry.');
                }
            });
        }

        // Product scanner functionality
        const productScannerBtn = document.getElementById('product-scanner-btn');
        if (productScannerBtn) {
            productScannerBtn.addEventListener('click', () => {
                // Check if camera is available
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    // Create scanner modal
                    const scannerModal = document.createElement('div');
                    scannerModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    scannerModal.innerHTML = `
                        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Scan Product Barcode</h3>
                                <button id="close-product-scanner" class="text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="text-center">
                                <div id="product-scanner-video" class="w-full h-64 bg-gray-100 rounded-lg mb-4 flex items-center justify-center">
                                    <div class="text-gray-500">
                                        <i data-lucide="camera" class="w-12 h-12 mx-auto mb-2"></i>
                                        <p>Camera access required for scanning</p>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <button id="start-product-scanner" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition-colors">
                                        Start Camera
                                    </button>
                                    <div class="text-sm text-gray-600">
                                        <p>Or enter barcode manually:</p>
                                        <input type="text" id="manual-product-barcode" placeholder="Enter barcode number" class="w-full mt-2 border border-gray-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <button id="search-product-barcode" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors">
                                            Search Product
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(scannerModal);
                    lucide.createIcons();
                    
                    // Close scanner modal
                    document.getElementById('close-product-scanner').addEventListener('click', () => {
                        scannerModal.remove();
                    });
                    
                    // Start camera
                    document.getElementById('start-product-scanner').addEventListener('click', () => {
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(stream => {
                                const video = document.createElement('video');
                                video.srcObject = stream;
                                video.play();
                                video.className = 'w-full h-64 object-cover rounded-lg';
                                document.getElementById('product-scanner-video').innerHTML = '';
                                document.getElementById('product-scanner-video').appendChild(video);
                                
                                // Simulate barcode detection (in real app, use a barcode library)
                                setTimeout(() => {
                                    const mockBarcode = 'PROD' + Math.random().toString(36).substr(2, 9);
                                    searchProductByBarcodeInProducts(mockBarcode);
                                    scannerModal.remove();
                                }, 3000);
                            })
                            .catch(err => {
                                alert('Camera access denied. Please use manual entry.');
                            });
                    });
                    
                    // Manual barcode search
                    document.getElementById('search-product-barcode').addEventListener('click', () => {
                        const barcode = document.getElementById('manual-product-barcode').value.trim();
                        if (barcode) {
                            searchProductByBarcodeInProducts(barcode);
                            scannerModal.remove();
                        } else {
                            alert('Please enter a barcode number');
                        }
                    });
                } else {
                    alert('Camera not available. Please use manual product search.');
                }
            });
        }
        
        function searchProductByBarcodeInProducts(barcode) {
            // Find product by barcode
            const product = products.find(p => p.barcode === barcode);
            if (product) {
                // Scroll to products view if not already there
                if (currentView !== 'products') {
                    switchView('products');
                }
                
                // Highlight the product in the list
                setTimeout(() => {
                    const productCards = document.querySelectorAll('.product-card');
                    productCards.forEach(card => {
                        const productName = card.querySelector('.product-name');
                        if (productName && productName.textContent.trim() === product.name) {
                            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            card.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
                            setTimeout(() => {
                                card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
                            }, 3000);
                        }
                    });
                }, 100);
                
                // Show success message
                addActivity(`Product "${product.name}" found by barcode!`, 'check-circle');
            } else {
                alert('Product not found with this barcode. Please add the product first.');
            }
        }

        // Quick add buttons for billing
        const quickAdd1Btn = document.getElementById('quick-add-1');
        const quickAdd5Btn = document.getElementById('quick-add-5');
        
        if (quickAdd1Btn) {
            quickAdd1Btn.addEventListener('click', () => {
                const currentQty = parseInt(document.getElementById('billing-qty').value) || 1;
                document.getElementById('billing-qty').value = currentQty + 1;
            });
        }
        
        if (quickAdd5Btn) {
            quickAdd5Btn.addEventListener('click', () => {
                const currentQty = parseInt(document.getElementById('billing-qty').value) || 1;
                document.getElementById('billing-qty').value = currentQty + 5;
            });
        }

        // Scanner functionality
        const scannerBtn = document.getElementById('scanner-btn');
        if (scannerBtn) {
            scannerBtn.addEventListener('click', () => {
                // Check if camera is available
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    // Create scanner modal
                    const scannerModal = document.createElement('div');
                    scannerModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    scannerModal.innerHTML = `
                        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Scan Product Barcode</h3>
                                <button id="close-scanner" class="text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="text-center">
                                <div id="scanner-video" class="w-full h-64 bg-gray-100 rounded-lg mb-4 flex items-center justify-center">
                                    <div class="text-gray-500">
                                        <i data-lucide="camera" class="w-12 h-12 mx-auto mb-2"></i>
                                        <p>Camera access required for scanning</p>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <button id="start-scanner" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg transition-colors">
                                        Start Camera
                                    </button>
                                    <div class="text-sm text-gray-600">
                                        <p>Or enter barcode manually:</p>
                                        <input type="text" id="manual-barcode" placeholder="Enter barcode number" class="w-full mt-2 border border-gray-300 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <button id="search-barcode" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors">
                                            Search Product
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(scannerModal);
                    lucide.createIcons();
                    
                    // Close scanner modal
                    document.getElementById('close-scanner').addEventListener('click', () => {
                        scannerModal.remove();
                    });
                    
                    // Start camera
                    document.getElementById('start-scanner').addEventListener('click', () => {
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(stream => {
                                const video = document.createElement('video');
                                video.srcObject = stream;
                                video.play();
                                video.className = 'w-full h-64 object-cover rounded-lg';
                                document.getElementById('scanner-video').innerHTML = '';
                                document.getElementById('scanner-video').appendChild(video);
                                
                                // Simulate barcode detection (in real app, use a barcode library)
                                setTimeout(() => {
                                    const mockBarcode = '1234567890';
                                    searchProductByBarcode(mockBarcode);
                                    scannerModal.remove();
                                }, 3000);
                            })
                            .catch(err => {
                                alert('Camera access denied. Please use manual entry.');
                            });
                    });
                    
                    // Manual barcode search
                    document.getElementById('search-barcode').addEventListener('click', () => {
                        const barcode = document.getElementById('manual-barcode').value.trim();
                        if (barcode) {
                            searchProductByBarcode(barcode);
                            scannerModal.remove();
                        } else {
                            alert('Please enter a barcode number');
                        }
                    });
                } else {
                    alert('Camera not available. Please use manual product selection.');
                }
            });
        }
        
        function searchProductByBarcode(barcode) {
            // Find product by barcode
            const product = products.find(p => p.barcode === barcode);
            if (product) {
                // Set the product in the dropdown
                document.getElementById('billing-product').value = product.name;
                
                // Trigger the change event to update unit and other fields
                const event = new Event('change', { bubbles: true });
                document.getElementById('billing-product').dispatchEvent(event);
                
                // Set quantity to 1
                document.getElementById('billing-qty').value = 1;
                
                // Update unit select
                const unitSelect = document.getElementById('billing-unit');
                unitSelect.innerHTML = `<option value="${product.unit}">${product.unit}</option>`;
                
                // Show success message
                addActivity(`Product "${product.name}" found by barcode!`, 'check-circle');
                
                // Highlight the product in the dropdown
                const productSelect = document.getElementById('billing-product');
                productSelect.style.backgroundColor = '#fef3c7';
                setTimeout(() => {
                    productSelect.style.backgroundColor = '';
                }, 2000);
                
                // Auto-add to bill
                setTimeout(() => {
                    handleAddToBill();
                }, 500);
            } else {
                alert('Product not found with this barcode. Please add the product first.');
            }
        }

        // Modal Buttons
        modalCancelBtn.addEventListener('click', closePaymentModal);
        modalSavePaymentBtn.addEventListener('click', savePaymentFromModal);

        // Edit Product Modal Listeners
        modalSaveProductBtn.addEventListener('click', saveProductChanges);
        modalCancelEditProductBtn.addEventListener('click', closeEditProductModal);
        editProductUnitInput.addEventListener('change', updateEditProductLabels);

        // PDF Download Buttons
        downloadCustomersBtn.addEventListener('click', downloadCustomersPDF);
        downloadProductsBtn.addEventListener('click', downloadProductsPDF);

        // Pagination Listeners
        customerPrevBtn.addEventListener('click', () => {
            if (customerCurrentPage > 1) {
                customerCurrentPage--;
                renderCustomers();
            }
        });
        customerNextBtn.addEventListener('click', () => {
            customerCurrentPage++;
            renderCustomers();
        });
        productPrevBtn.addEventListener('click', () => {
            if (productCurrentPage > 1) {
                productCurrentPage--;
                renderProducts();
            }
        });
        productNextBtn.addEventListener('click', () => {
            productCurrentPage++;
            renderProducts();
        });

        // Settings Listeners
        clearDataBtn.addEventListener('click', () => {
            const lang = uiText[currentLanguage];
             showConfirmationModal(
                 lang.settings_clear_confirm_title || "Confirm Clear Data",
                 lang.settings_clear_confirm_text || "Are you absolutely sure you want to delete all data?",
                 () => { 
                     customers = [];
                     products = [];
                     purchaseOrders = [];
                     renderCustomers();
                     renderProducts();
                     renderPurchaseOrders();
                     updateDashboardCards();
                     updateDashboardAlerts();
                     addActivity(lang.settings_data_cleared || "All data cleared.", 'trash-2');
                 }
             );
        });

        saveCredentialsBtn.addEventListener('click', () => {
             const lang = uiText[currentLanguage];
             const newUser = newUsernameInput.value.trim();
             const newPass = newPasswordInput.value;
             const confirmPass = confirmPasswordInput.value;

             credentialStatus.textContent = ''; 

             if (!newUser || !newPass || !confirmPass) {
                 credentialStatus.textContent = lang.settings_creds_error || 'Please fill all fields.';
                 credentialStatus.classList.add('text-red-600');
                 credentialStatus.classList.remove('text-green-600');
                 return;
             }

             if (newPass !== confirmPass) {
                 credentialStatus.textContent = lang.settings_pass_mismatch || 'Passwords do not match.';
                  credentialStatus.classList.add('text-red-600');
                 credentialStatus.classList.remove('text-green-600');
                 return;
             }

             currentUsername = newUser;
             currentPassword = newPass;

             displayUsername.textContent = currentUsername;

             credentialStatus.textContent = lang.settings_creds_updated || 'Credentials updated successfully.';
             credentialStatus.classList.remove('text-red-600');
             credentialStatus.classList.add('text-green-600');

             newPasswordInput.value = '';
             confirmPasswordInput.value = '';

        });

        // Low Stock Threshold Setting
        const lowStockThresholdInput = document.getElementById('low-stock-threshold');
        const saveLowStockThresholdBtn = document.getElementById('save-low-stock-threshold');
        const thresholdStatus = document.getElementById('threshold-status');
        
        // Load saved threshold on page load
        const savedThreshold = localStorage.getItem('lowStockThreshold');
        if (savedThreshold) {
            lowStockThresholdInput.value = savedThreshold;
        }

        saveLowStockThresholdBtn.addEventListener('click', () => {
            const lang = uiText[currentLanguage];
            const threshold = parseInt(lowStockThresholdInput.value);
            
            thresholdStatus.textContent = '';
            
            if (isNaN(threshold) || threshold < 1 || threshold > 100) {
                thresholdStatus.textContent = lang.threshold_error || 'Please enter a valid threshold value.';
                thresholdStatus.classList.add('text-red-600');
                thresholdStatus.classList.remove('text-green-600');
                return;
            }
            
            // Save threshold to localStorage
            localStorage.setItem('lowStockThreshold', threshold.toString());
            
            thresholdStatus.textContent = lang.threshold_saved || 'Low stock threshold saved successfully.';
            thresholdStatus.classList.add('text-green-600');
            thresholdStatus.classList.remove('text-red-600');
            
            // Update dashboard alerts with new threshold
            updateDashboardAlerts();
        });

        // Confirmation Modal Listeners
        confirmModalCancelBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });

        confirmModalOkBtn.addEventListener('click', () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });


        // --- Core Logic ---

        function addMessageToChat(sender, message) {
            const bubble = document.createElement('div');
            bubble.classList.add('bubble', sender === 'user' ? 'user-bubble' : 'ai-bubble');
            bubble.textContent = message; 
            chatLog.appendChild(bubble);
            chatLog.scrollTop = chatLog.scrollHeight;
        }
        
        async function addCustomerToList(customerData, speakSuccess = false) {
            const lang = uiText[currentLanguage];
            if (!customerData || !customerData.name) {
                const msg = lang.ai_name_missing;
                if (speakSuccess) {
                    addMessageToChat('ai', msg);
                    speak(msg);
                } 
                return;
            }

            try {
                const existingCustomerIndex = customers.findIndex(c => c.name.toLowerCase() === customerData.name.toLowerCase());
                
                const dataWithTimestamp = {
                    ...customerData,
                    createdAt: new Date()
                };

                if (existingCustomerIndex > -1) {
                    const existingCustomer = customers[existingCustomerIndex];
                    
                    // --- LOGIC FIX HERE ---
                    // If a balance is passed with 'addCustomer', it should ADD to the existing balance.
                    // e.g., "Ravi ke 50 baki" (balanceDue: 50) -> adds 50 to existing balance.
                    const newBalanceDue = (existingCustomer.balanceDue || 0) + (customerData.balanceDue || 0);

                    // If new products are passed, merge them without duplicates
                    const existingProducts = existingCustomer.products || [];
                    const newProducts = customerData.products || [];
                    const allProducts = [...new Set([...existingProducts, ...newProducts])]; // Merge and dedupe

                    customers[existingCustomerIndex] = {
                        ...existingCustomer,
                        ...customerData, // This will overwrite name if it's slightly different (e.g., case)
                        products: allProducts, // Use the merged product list
                        balanceDue: newBalanceDue, // But we use our calculated new balance
                        createdAt: existingCustomer.createdAt // Keep original creation date
                    };
                    // --- END LOGIC FIX ---
                } else {
                    customers.unshift(dataWithTimestamp); 
                }

                renderCustomers(); 
                updateDashboardCards();
                
                const successMsg = `${lang.ai_add_success} ${customerData.name}.`;
                addActivity(successMsg, 'user-plus');
                
                if(speakSuccess) {
                    status.textContent = successMsg;
                    addMessageToChat('ai', successMsg);
                    speak(successMsg);
                } 
                
            } catch (error) {
                console.error("Error adding/updating customer: ", error);
                const errorMsg = lang.ai_save_error;
                if(speakSuccess) {
                    status.textContent = errorMsg;
                    addMessageToChat('ai', errorMsg);
                    speak(errorMsg);
                }
            }
        }

        function deleteCustomer(customerName) {
            const lang = uiText[currentLanguage];
            const customerIndex = customers.findIndex(c => c.name.toLowerCase() === customerName.toLowerCase());

            if (customerIndex > -1) {
                 const customer = customers[customerIndex];
                 if (customer.balanceDue && customer.balanceDue > 0) {
                      const balanceErrorMsg = lang.ai_delete_balance_error || "Cannot delete customer with a balance due.";
                      addActivity(`${balanceErrorMsg} (${customerName})`, 'alert-circle');
                      return; 
                 }

                customers.splice(customerIndex, 1); 
                renderCustomers(); 
                updateDashboardCards();
                
                const successMsg = `${lang.ai_delete_success} ${customerName}.`;
                if (currentView === 'assistant') {
                    status.textContent = successMsg;
                    addMessageToChat('ai', successMsg);
                    speak(successMsg);
                }
                addActivity(successMsg, 'user-minus');
                
            } else {
                const errorMsg = `${lang.ai_delete_not_found} ${customerName}.`;
                 if (currentView === 'assistant') {
                    status.textContent = errorMsg;
                    addMessageToChat('ai', errorMsg);
                    speak(errorMsg);
                 }
                 addActivity(errorMsg, 'alert-circle');
            }
        }

        function queryBalance(customerName) {
            const lang = uiText[currentLanguage];
            const customer = customers.find(c => c.name.toLowerCase() === customerName.toLowerCase());

            if (customer) {
                const balance = customer.balanceDue || 0;
                let response;
                if (balance > 0) {
                    response = `${lang.ai_query_balance_prefix} ${customer.name} ${lang.ai_query_balance_suffix}${balance.toFixed(2)}.`;
                } else if (balance < 0) {
                    response = `${lang.ai_query_balance_prefix} ${customer.name} ${lang.credit_balance || 'Credit'}: ₹${Math.abs(balance).toFixed(2)}.`;
                } else {
                    response = `${customer.name} ${lang.ai_query_balance_zero}`;
                }
                addMessageToChat('ai', response);
                speak(response);
            } else {
                const errorMsg = `${lang.ai_query_not_found} ${customerName}.`;
                addMessageToChat('ai', errorMsg);
                speak(errorMsg);
            }
        }

        function queryStock(productName) {
             const lang = uiText[currentLanguage];
            const product = products.find(p => p.name.toLowerCase() === productName.toLowerCase());

            if (product) {
                const stock = product.stock || 0;
                const unit = product.unit === 'kg' ? 'kg' : (lang.unit_pcs || 'pcs');
                let response = `${lang.ai_query_stock_response_prefix}${stock} ${unit}${lang.ai_query_stock_response_suffix}${product.name}${lang.ai_query_stock_response_instock}`;
                addMessageToChat('ai', response);
                speak(response);
            } else {
                const errorMsg = `${lang.ai_query_not_found} ${productName}.`;
                addMessageToChat('ai', errorMsg);
                speak(errorMsg);
            }
        }
        
        function payBalance(customerName, amountPaid) {
             const lang = uiText[currentLanguage];
            const customerIndex = customers.findIndex(c => c.name.toLowerCase() === customerName.toLowerCase());
            
            if (customerIndex > -1) {
                const customer = customers[customerIndex];
                const oldBalance = customer.balanceDue || 0;
                const newBalance = oldBalance - amountPaid;
                customer.balanceDue = newBalance;
                
                renderCustomers(); 
                updateDashboardCards();
                
                let successMsg;
                if (customer.balanceDue < 0) {
                     successMsg = `${customerName}${lang.ai_pay_success_prefix}${amountPaid}. ${lang.credit_balance || 'New Credit'}: ₹${Math.abs(customer.balanceDue).toFixed(2)}.`;
                } else {
                     successMsg = `${customerName}${lang.ai_pay_success_prefix}${amountPaid}${lang.ai_pay_success_suffix}${customer.balanceDue.toFixed(2)}.`;
                }

                status.textContent = successMsg;
                addActivity(successMsg, 'indian-rupee');
                addMessageToChat('ai', successMsg);
                speak(successMsg);
                
            } else {
                const errorMsg = `${lang.ai_query_not_found} ${customerName}.`;
                status.textContent = errorMsg;
                addMessageToChat('ai', errorMsg);
                speak(errorMsg);
            }
        }

        async function addProductToList(productData, speakSuccess = false) {
             const lang = uiText[currentLanguage];
            if (!productData || !productData.name) {
                const msg = lang.ai_name_missing;
                if (speakSuccess) {
                    addMessageToChat('ai', msg);
                    speak(msg);
                } 
                return;
            }

            try {
                const existingIndex = products.findIndex(p => p.name.toLowerCase() === productData.name.toLowerCase());
                
                if (existingIndex > -1) {
                    products[existingIndex] = { ...products[existingIndex], ...productData };
                } else {
                    products.unshift(productData);
                }
                renderProducts(); 
                updateDashboardCards();
                updateDashboardAlerts(); 
                const msg = `${lang.ai_add_product_success} ${productData.name}`;
                addActivity(msg, 'package-plus');

                if (speakSuccess) {
                    status.textContent = msg;
                    addMessageToChat('ai', msg);
                    speak(msg);
                } 
            } catch (error) {
                console.error("Error saving product: ", error);
                const errorMsg = "Error saving product.";
                if(speakSuccess) {
                    status.textContent = errorMsg;
                    addMessageToChat('ai', errorMsg);
                    speak(errorMsg);
                } 
            }
        }

        function createBillAI(customerName, items) {
             const lang = uiText[currentLanguage];
            let customerIndex = customers.findIndex(c => c.name.toLowerCase() === customerName.toLowerCase());
            
            if (customerIndex === -1) {
                addCustomerToList({ name: customerName, balanceDue: 0, products: [] });
                customerIndex = customers.findIndex(c => c.name.toLowerCase() === customerName.toLowerCase());
                addActivity(`New customer "${customerName}" added.`, 'user-plus');
            }

            if (!items || items.length === 0) {
                addMessageToChat('ai', lang.ai_bill_no_items);
                speak(lang.ai_bill_no_items);
                return;
            }

            let billTotal = 0;
            let billCost = 0;
            let stockUpdates = [];
            let itemDetails = [];

            for (const item of items) {
                const product = products.find(p => p.name.toLowerCase() === item.productName.toLowerCase());
                
                if (!product) {
                    const errorMsg = `${lang.ai_bill_item_not_found} ${item.productName}.`;
                    addMessageToChat('ai', errorMsg);
                    speak(errorMsg);
                    return; 
                }

                const unitPrice = product.sellingPrice;
                const costPrice = product.costPrice || 0;
                const productUnit = product.unit;
                const billingQty = item.quantity;
                const billingUnit = item.unit; 

                let lineItemTotalPrice = 0;
                let stockToDeduct = 0;
                let lineItemCost = 0;

                if (productUnit === 'piece') {
                    stockToDeduct = billingQty;
                    lineItemTotalPrice = billingQty * unitPrice;
                    lineItemCost = billingQty * costPrice;
                } else if (productUnit === 'kg') {
                    if (billingUnit === 'g') {
                        stockToDeduct = billingQty / 1000;
                    } else { 
                        stockToDeduct = billingQty;
                    }
                    lineItemTotalPrice = stockToDeduct * unitPrice;
                    lineItemCost = stockToDeduct * costPrice;
                }

                if (stockToDeduct > product.stock) {
                      const errorMsg = `${lang.ai_bill_stock_error_prefix} ${item.productName}. Only ${product.stock} ${productUnit} available. ${lang.ai_bill_stock_error_suffix}`;
                    addMessageToChat('ai', errorMsg);
                    speak(errorMsg);
                    return; 
                }

                billTotal += lineItemTotalPrice;
                billCost += lineItemCost;
                stockUpdates.push({ index: products.indexOf(product), deduct: stockToDeduct });
                itemDetails.push(`${item.quantity} ${billingUnit} ${item.productName}`);
            }

            stockUpdates.forEach(update => {
                products[update.index].stock -= update.deduct;
            });
            
            customers[customerIndex].balanceDue = (customers[customerIndex].balanceDue || 0) + billTotal;
            const newBalance = customers[customerIndex].balanceDue;

            const currentBillProductNames = items.map(item => item.productName); // Corrected: use items from param
            customers[customerIndex].products = customers[customerIndex].products || [];
            currentBillProductNames.forEach(newItem => {
                if (!customers[customerIndex].products.includes(newItem)) {
                    customers[customerIndex].products.push(newItem);
                }
            });

            renderCustomers();
            renderProducts();
            updateDashboardCards();
            updateDashboardAlerts();

            const billProfit = billTotal - billCost;
            let balanceString = "";
            if (newBalance > 0) {
                balanceString = `₹${newBalance.toFixed(2)}`;
            } else if (newBalance < 0) {
                balanceString = `₹${Math.abs(newBalance).toFixed(2)} ${lang.credit_balance}`;
            } else {
                balanceString = `₹0.00`;
            }

            const successMsg = `${lang.ai_bill_created_prefix} ${customerName} (₹${billTotal.toFixed(2)}). ${lang.ai_bill_created_suffix} ${balanceString}.`;
            addActivity(`Bill for ${customerName}: ${itemDetails.join(', ')} (Total: ₹${billTotal.toFixed(2)})`, 'receipt');
            transactions.push({ type: 'sale', date: new Date(), total: billTotal, cost: billCost, profit: billProfit, customer: customerName, items: items });
            addMessageToChat('ai', successMsg);
            speak(successMsg);
        }

        async function handleAutoQuery(query) {
             const lang = uiText[currentLanguage];
            loadingIndicator.classList.remove('hidden');
            status.textContent = lang.status_processing;

            if (lang['hi-IN'] && (query.includes('बैलेंस') || query.includes('balance')) && (query.includes('क्या') || query.includes('kitna'))) {
                 query = "query balance " + query;
            }
            if ((query.includes('stock') || query.includes('स्टॉक')) && (query.includes('what') || query.includes('kitna'))) {
                 query = "query stock " + query;
            }

            try {
                const result = await getStructuredDataFromGemini(query);
                
                if (!result || !result.intent) {
                    throw new Error("Failed to parse command.");
                }

                switch (result.intent) {
                    case 'addCustomer': 
                        // Show confirmation dialog with options
                        const customerName = result.customerName;
                        const balanceDue = result.balanceDue || 0;
                        const products = result.products || [];
                        
                        let confirmMessage = `Add customer "${customerName}"`;
                        if (balanceDue > 0) {
                            confirmMessage += ` with balance ₹${balanceDue}`;
                        }
                        if (products.length > 0) {
                            confirmMessage += ` and products: ${products.join(', ')}`;
                        }
                        confirmMessage += '?';
                        
                        addMessageToChat('ai', confirmMessage);
                        speak(confirmMessage);
                        
                        // Show options for user to confirm
                        setTimeout(() => {
                            addMessageToChat('ai', 'Say "yes" to confirm or "no" to cancel. You can also say "modify" to change details.');
                        }, 1000);
                        
                        // Store pending customer data for confirmation
                        window.pendingCustomerData = {
                            name: customerName,
                            balanceDue: balanceDue,
                            products: products
                        };
                        break;
                    
                    case 'addProduct':
                        // Show confirmation dialog with options
                        const productName = result.productName;
                        const unit = result.unit || 'piece';
                        const stock = result.stock || 0;
                        const costPrice = result.costPrice || 0;
                        const sellingPrice = result.sellingPrice || 0;
                        const mfgDate = result.mfgDate || null;
                        const expDate = result.expDate || null;
                        
                        let productConfirmMessage = `Add product "${productName}"`;
                        if (stock > 0) {
                            productConfirmMessage += ` with stock ${stock} ${unit}`;
                        }
                        if (costPrice > 0) {
                            productConfirmMessage += `, cost price ₹${costPrice}`;
                        }
                        if (sellingPrice > 0) {
                            productConfirmMessage += `, selling price ₹${sellingPrice}`;
                        }
                        if (mfgDate) {
                            productConfirmMessage += `, manufactured on ${mfgDate}`;
                        }
                        if (expDate) {
                            productConfirmMessage += `, expires on ${expDate}`;
                        }
                        productConfirmMessage += '?';
                        
                        addMessageToChat('ai', productConfirmMessage);
                        speak(productConfirmMessage);
                        
                        // Show options for user to confirm
                        setTimeout(() => {
                            addMessageToChat('ai', 'Say "yes" to confirm or "no" to cancel. You can also say "modify" to change details.');
                        }, 1000);
                        
                        // Store pending product data for confirmation
                        window.pendingProductData = {
                            name: productName,
                            unit: unit,
                            stock: stock,
                            costPrice: costPrice,
                            sellingPrice: sellingPrice,
                            mfgDate: mfgDate,
                            expDate: expDate,
                            imageUrl: `https://placehold.co/128x128/ffedd5/f97316?text=${productName || 'Image'}`
                        };
                        break;

                    case 'confirmAdd':
                        // Handle confirmation for pending operations
                        if (window.pendingCustomerData) {
                            await addCustomerToList(window.pendingCustomerData, true);
                            window.pendingCustomerData = null;
                            addMessageToChat('ai', 'Customer added successfully!');
                            speak('Customer added successfully!');
                        } else if (window.pendingProductData) {
                            await addProductToList(window.pendingProductData, true);
                            window.pendingProductData = null;
                            addMessageToChat('ai', 'Product added successfully!');
                            speak('Product added successfully!');
                        } else {
                            addMessageToChat('ai', 'No pending operation to confirm.');
                            speak('No pending operation to confirm.');
                        }
                        break;

                    case 'cancelAdd':
                        // Handle cancellation for pending operations
                        if (window.pendingCustomerData || window.pendingProductData) {
                            window.pendingCustomerData = null;
                            window.pendingProductData = null;
                            addMessageToChat('ai', 'Operation cancelled.');
                            speak('Operation cancelled.');
                        } else {
                            addMessageToChat('ai', 'No pending operation to cancel.');
                            speak('No pending operation to cancel.');
                        }
                        break;

                    case 'modifyAdd':
                        // Handle modification for pending operations
                        if (window.pendingCustomerData) {
                            addMessageToChat('ai', 'Please provide the updated customer details. Say something like "change name to John" or "change balance to 100".');
                            speak('Please provide the updated customer details.');
                        } else if (window.pendingProductData) {
                            addMessageToChat('ai', 'Please provide the updated product details. Say something like "change stock to 50" or "change price to 25".');
                            speak('Please provide the updated product details.');
                        } else {
                            addMessageToChat('ai', 'No pending operation to modify.');
                            speak('No pending operation to modify.');
                        }
                        break;

                    case 'deleteCustomer':
                        if (result.customerName) {
                            deleteCustomer(result.customerName);
                        } else {
                            addMessageToChat('ai', lang.ai_name_missing);
                            speak(lang.ai_name_missing);
                        }
                        break;
                    
                    case 'queryCustomerDetails':
                        if (result.customerName) {
                            const customer = customers.find(c => c.name.toLowerCase() === result.customerName.toLowerCase());
                            if (customer) {
                                const msg = `${lang.ai_details_showing} ${customer.name}.`;
                                addMessageToChat('ai', msg);
                                speak(msg);
                                switchView('customers');
                                customerSearchInput.value = customer.name;
                                handleCustomerSearch();
                            } else {
                                const errorMsg = `${lang.ai_query_not_found} ${result.customerName}.`;
                                addMessageToChat('ai', errorMsg);
                                speak(errorMsg);
                            }
                        } else {
                            addMessageToChat('ai', lang.ai_name_missing);
                            speak(lang.ai_name_missing);
                        }
                        break;
                        
                    case 'queryBalance':
                         if (result.customerName) {
                             queryBalance(result.customerName);
                         } else {
                            addMessageToChat('ai', lang.ai_name_missing);
                            speak(lang.ai_name_missing);
                         }
                         break;
                    
                    case 'queryStock':
                         if (result.productName) {
                             queryStock(result.productName);
                         } else {
                            addMessageToChat('ai', lang.ai_name_missing);
                            speak(lang.ai_name_missing);
                         }
                         break;

                    case 'payBalance':
                        if (result.customerName && (result.amountPaid || result.amountPaid === 0)) {
                            payBalance(result.customerName, result.amountPaid);
                        } else if (result.customerName) {
                            addMessageToChat('ai', lang.ai_pay_missing_amount);
                            speak(lang.ai_pay_missing_amount);
                        } else {
                            addMessageToChat('ai', lang.ai_name_missing);
                            speak(lang.ai_name_missing);
                        }
                        break;
                    
                    case 'createBill':
                        if (result.customerName) {
                            createBillAI(result.customerName, result.items);
                        } else {
                            addMessageToChat('ai', lang.ai_name_missing);
                            speak(lang.ai_name_missing);
                        }
                        break;
                    
                    case 'general':
                        if (query.toLowerCase().includes("time") || query.toLowerCase().includes("samay")) {
                            const now = new Date();
                            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            addMessageToChat('ai', `The current time is ${time}.`);
                            speak(`The current time is ${time}.`);
                        } else {
                            addMessageToChat('ai', "I can help with customer, product data, billing, and payments."); 
                            speak("I can help with customer, product data, billing, and payments.");
                        }
                        break;
                    
                    case 'error':
                    default:
                        addMessageToChat('ai', lang.ai_parse_error);
                        speak(lang.ai_parse_error);
                        break;
                }

            } catch (error) {
                console.error("Error in handleAutoQuery:", error.message);
                addMessageToChat('ai', lang.ai_parse_error);
                speak(lang.ai_parse_error);
            } finally {
                loadingIndicator.classList.add('hidden');
                if (!micBtn.classList.contains('listening')) {
                     status.textContent = lang.status_ready;
                }
            }
        }

        async function getStructuredDataFromGemini(prompt) {
             // Use empty string for API key as required
             const apiKey = "AIzaSyDiqf-vNMjF5SdGzC_15FwZ5IOyAjtuVVM";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const lang = uiText[currentLanguage];
            const systemPrompt = `You are a grocery store ERP assistant. Your #1 goal is to understand the user's intent. Parse the user's command to extract data.
            - The user is speaking ${currentLanguage}. They are speaking natural, fast 'whatsapp' Hinglish, and the speech-to-text will be very imperfect.
            - **CRITICAL**: You MUST try to guess the user's intent and extract entities. Do not be afraid to 'autocorrect' a badly transcribed name. **It is better to make a reasonable guess than to fail.**
            - **Example 1**: 'modi ke 20 baki h' -> intent: 'addCustomer', customerName: 'Modi', balanceDue: 20.
            - **Example 2**: 'xyz again paid 20' -> intent: 'payBalance', customerName: 'xyz', amountPaid: 20. (Ignore 'again').
            - **Example 3**: 'Bingo ke kitne packet hai' -> intent: 'queryStock', productName: 'Bingo'.
            - **Currency is Indian Rupees (₹).** All monetary values are in ₹.
            - **Intents**:
              - 'addCustomer': For adding or updating a customer. Requires 'customerName'. 'balanceDue' and 'products' are optional. (e.g., "add customer Rahul", "Rahul balance 50", "Rahul ka balance 100 kar do", "XYZ due 100", "XYZ ke 100 rupee baki", "modi ke 20 baki h"). 'baki', 'due', 'pad', 'remaining' should be parsed as a positive 'balanceDue'. **If the command includes 'paid' or 'jama', it is 'payBalance' intent, NOT 'addCustomer'.**
              - 'addProduct': For adding or updating a product. Requires 'productName'. 'stock', 'costPrice', 'sellingPrice', 'mfgDate', 'expDate', 'unit' ('kg' or 'piece') are optional. (e.g., "add product Bingo, stock 50, cost 10, price 12", "Sev add karo, unit kg, price 180", "update XYZ stock 20", "XYZ price 15 rupees"). If only a 'productName' is given (e.g., "add product sugar"), this is also a valid 'addProduct' intent; set other fields to null/0.
              - 'confirmAdd': For confirming a pending add operation. (e.g., "yes", "confirm", "add it", "okay", "sure")
              - 'cancelAdd': For canceling a pending add operation. (e.g., "no", "cancel", "don't add", "stop")
              - 'modifyAdd': For modifying a pending add operation. (e.g., "modify", "change", "edit")
              - 'deleteCustomer': For removing a customer. Requires 'customerName'. (e.g., "delete customer Rahul", "Rahul ko delete karo")
              - 'queryBalance': For asking about a customer's balance. Requires 'customerName'. (e.g., "how much balance for Rahul?", "Rahul ka balance kitna hai?")
              - 'queryStock': For asking about product stock. Requires 'productName'. (e.g., "how many Bingo in stock?", "Bingo ke kitne packet hai?")
              - 'queryCustomerDetails': For asking to see all details for a customer. Requires 'customerName'. (e.g., "Show me Hariom's details", "open Hariom", "Hariom ka record")
              - 'payBalance': For a customer paying off part of their balance. Requires 'customerName' and 'amountPaid'. (e.g., "Hariom paid 200", "Hariom ne 200 diye", "subtract 200 from Hariom's balance", "XYZ paid 50 rupees", "XYZ ne 50 jama kiye", "xyz again paid 20"). 'paid', 'jama', 'pets', 'jama kiye', 'jama kar diye' mean payment received, parse as 'amountPaid'. **Even if the user says "add customer XYZ paid 50", this is a 'payBalance' intent.**
              - 'createBill': For billing a customer for items. Requires 'customerName' and 'items' (array). (e.g., "Bill Rahul for 10 Bingo and 50g Sev", "Rahul ke account mein 10 Parle aur 100 gram Kaju daal do", "Bill for XYZ, 2 Maggi, 1 Bingo")
              - 'general': For any other chat. (e.g., "what is the time?", "kaise ho?")

            - **Item Parsing for 'createBill'**:
              - 'items' is an array of objects: { productName, quantity, unit }.
              - 'unit' should be 'g' (grams), 'kg' (kilograms), or 'pcs'/'piece'.
              - "10 Bingo" -> { productName: "Bingo", quantity: 10, unit: "pcs" }
              - "50g Sev" or "50 gram sev" -> { productName: "Sev", quantity: 50, unit: "g" }
              - "1kg Kaju" -> { productName: "Kaju", quantity: 1, unit: "kg" }
            - Dates (mfgDate, expDate) should be in YYYY-MM-DD format if possible.
            - **Only return 'error' intent** if the command is complete gibberish (e.g., 'asdfg asdfg') or if a critical piece of information (like a name for a balance query) is completely missing and un-guessable.
            - Always return a valid JSON.
            `;
            
            const schema = { /* Schema remains the same */
                "type": "OBJECT",
                "properties": {
                    "intent": { "type": "STRING", "enum": ["addCustomer", "addProduct", "confirmAdd", "cancelAdd", "modifyAdd", "deleteCustomer", "queryBalance", "queryStock", "queryCustomerDetails", "payBalance", "createBill", "general", "error"] },
                    "customerName": { "type": "STRING" },
                    "balanceDue": { "type": "NUMBER" },
                    "amountPaid": { "type": "NUMBER" },
                    "products": { "type": "ARRAY", "items": { "type": "STRING" } },
                    "productName": { "type": "STRING" },
                    "stock": { "type": "NUMBER" },
                    "costPrice": { "type": "NUMBER" },
                    "sellingPrice": { "type": "NUMBER" },
                    "unit": { "type": "STRING", "enum": ["piece", "kg"] },
                    "mfgDate": { "type": "STRING" }, 
                    "expDate": { "type": "STRING" }, 
                    "items": { 
                        "type": "ARRAY",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "productName": { "type": "STRING" },
                                "quantity": { "type": "NUMBER" },
                                "unit": { "type": "STRING", "enum": ["g", "kg", "pcs", "piece"] }
                            },
                             "required": ["productName", "quantity", "unit"]
                        }
                    }
                },
                "required": ["intent"]
            };

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };
            
            try {
                let response;
                let delay = 1000;
                for (let i = 0; i < 3; i++) { 
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break; 
                    if (response.status === 429 || response.status >= 500) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        break;
                    }
                }
                if (!response.ok) {
                    console.error(`API request failed with status: ${response.status}`);
                    const errorBody = await response.text();
                    console.error("Error body:", errorBody);
                    return { intent: 'error' };
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text;
                    return JSON.parse(jsonText);
                } else {
                    console.error("Invalid response structure:", result);
                    return { intent: 'error' };
                }
            } catch (error) {
                console.error("Fetch or JSON parse error:", error);
                return { intent: 'error' };
            }
        }

        // Authentication API Functions
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            const config = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };
            
            try {
                const response = await fetch(url, config);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API request error:', error);
                throw error;
            }
        }

        async function loginSeller(email, password) {
            try {
                const requestData = { email, password };
                
                // Show request data in alert
                alert(`LOGIN REQUEST:\n${JSON.stringify(requestData, null, 2)}`);
                
                const response = await apiRequest('/seller/login', {
                    method: 'POST',
                    body: JSON.stringify(requestData)
                });
                
                // Show response in alert
                alert(`LOGIN RESPONSE:\n${JSON.stringify(response, null, 2)}`);
                
                if (response.success) {
                    isAuthenticated = true;
                    currentUser = response.data;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                }
                
                return response;
            } catch (error) {
                console.error('Login error:', error);
                alert(`LOGIN ERROR:\n${error.message}`);
                return { success: false, message: 'Login failed' };
            }
        }

        async function registerSeller(sellerData) {
            console.log("sellerData",sellerData);
            try {
                // Show request data in alert
                alert(`REGISTER REQUEST:\n${JSON.stringify(sellerData, null, 2)}`);
                
                const response = await apiRequest('/seller/register', {
                    method: 'POST',
                    body: JSON.stringify(sellerData)
                });
                
                // Show response in alert
                alert(`REGISTER RESPONSE:\n${JSON.stringify(response, null, 2)}`);
                
                return response;
            } catch (error) {
                console.error('Registration error:', error);
                alert(`REGISTER ERROR:\n${error.message}`);
                return { success: false, message: 'Registration failed' };
            }
        }

        async function verifyOtpAndRegister(otp) {
            try {
                const requestData = { otp };
                
                // Show request data in alert
                alert(`OTP VERIFICATION REQUEST:\n${JSON.stringify(requestData, null, 2)}`);
                
                const response = await apiRequest('/seller/verifyOtpAndRegister', {
                    method: 'POST',
                    body: JSON.stringify(requestData)
                });
                
                // Show response in alert
                alert(`OTP VERIFICATION RESPONSE:\n${JSON.stringify(response, null, 2)}`);
                
                if (response.success) {
                    // Registration successful, now login automatically
                    const loginResponse = await loginSeller(signupEmailInput.value, signupPasswordInput.value);
                    if (loginResponse.success) {
                        isAuthenticated = true;
                        currentUser = loginResponse.data;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                    }
                }
                
                return response;
            } catch (error) {
                console.error('OTP verification error:', error);
                alert(`OTP VERIFICATION ERROR:\n${error.message}`);
                return { success: false, message: 'OTP verification failed' };
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        async function fetchProductImage(productName, updatePreview = true) {
             // Use empty string for API key as required
             const apiKey = "AIzaSyDiqf-vNMjF5SdGzC_15FwZ5IOyAjtuVVM";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = `You are an image search assistant. The user will provide a product name. Find a single, high-quality, publicly accessible image URL (e.g., from a CDN, wikimedia, or manufacturer site, NOT a search results page) for this grocery product. Return *only* the URL as a plain string. If no image is found, return the string 'NOT_FOUND'.`;
            
            const payload = {
                contents: [{ parts: [{ text: `grocery item: ${productName}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }] 
            };
            
            // This function is now only called by AI, so we update the product list image directly later.
            // No need for loader or preview updates here.

            try {
                let response;
                let delay = 1000;
                for (let i = 0; i < 3; i++) { 
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break; 
                    if (response.status === 429 || response.status >= 500) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        break;
                    }
                }
                if (!response.ok) {
                    throw new Error(`API request failed with status: ${response.status}`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const imageUrl = candidate.content.parts[0].text.trim();
                    if (imageUrl !== 'NOT_FOUND' && imageUrl.startsWith('http')) {
                        return imageUrl; // Return the URL
                    } 
                }
            } catch (error) {
                console.error("Fetch or JSON parse error for image:", error);
            } 
            // Return null if no valid URL found
             return null; 
        }

        async function fetchAndUpdateProductImage(productName) {
            const newImgUrl = await fetchProductImage(productName, false);
            if (newImgUrl) {
                const productIndex = products.findIndex(p => p.name.toLowerCase() === productName.toLowerCase());
                if (productIndex > -1) {
                    products[productIndex].imageUrl = newImgUrl;
                    // Only re-render the product list if the user is currently looking at it
                    if (currentView === 'products') {
                        renderProducts();
                    }
                }
            }
        }

        // --- Confirmation Modal Function ---
        function showConfirmationModal(title, text, onConfirm) {
            confirmModalTitle.textContent = title;
            confirmModalText.textContent = text;
            confirmCallback = onConfirm; 
            confirmModal.classList.remove('hidden');
        }
        
        // --- Initial Load ---
        
        function loadDummyData() {
            products = [
                { name: "Test Product 1", barcode: "1234567890", unit: "piece", stock: 10, costPrice: 50, sellingPrice: 60, mfgDate: "2024-01-01", expDate: "2024-12-31", imageUrl: "https://placehold.co/128x128/ffedd5/f97316?text=Test1" },
                { name: "Test Product 2", barcode: "0987654321", unit: "kg", stock: 5, costPrice: 30, sellingPrice: 40, mfgDate: "2024-01-01", expDate: "2024-12-31", imageUrl: "https://placehold.co/128x128/ffedd5/f97316?text=Test2" },
                { name: "Low Stock Item", barcode: "1122334455", unit: "piece", stock: 3, costPrice: 15, sellingPrice: 20, mfgDate: "2024-01-01", expDate: "2024-12-31", imageUrl: "https://placehold.co/128x128/ffedd5/f97316?text=LowStock" }
            ];
            customers = [];
            
            renderProducts();
            renderCustomers();
            updateDashboardCards();
        }
        
        loadDummyData();
        updateUIText(); 
        // UI-MOD: Set dashboard as active on initial load using the switchView function
        // switchView('dashboard'); 
        // This is handled by the login button now.
        
        // REMOVED: switchManualTab
        updateDashboardAlerts(); 
        lucide.createIcons(); 

    </script>
</body>
</html>
